# 产品核心框架 v2.0

> 基于所有历史版本(v1~v1.1.4)的最优设计整合 + 新增知识点层
> 创建日期：2026-02-06

---

## 一、逻辑页三Tab架构

### 已确认：三个Tab
| Tab | 名称 | 核心功能 |
|-----|------|---------|
| 1 | 知识点 | 基础知识结构树（概念/公式/定律/性质） |
| 2 | 模型/方法 | 解题框架结构树（问题解决模型） |
| 3 | 高考卷子视角 | 按题型/题号定位问题 |

### 层级结构（已确认：强制三级）

**所有学科、所有Tab统一三级结构**

#### 知识点Tab三级
| Level 1 | Level 2 | Level 3 |
|---------|---------|---------|
| 章（静电场） | 节（第一节·电荷） | 具体知识点（电荷量/元电荷/起电方式） |

#### 模型/方法Tab三级
| Level 1 | Level 2 | Level 3 |
|---------|---------|---------|
| 章（静电场） | 模型（库仑力平衡） | 子问题类型（两个点电荷/三个点电荷） |

#### 高考卷子Tab三级
| Level 1 | Level 2 | Level 3 |
|---------|---------|---------|
| 题型（选择题1-8） | 题号（第3题） | 关联内容（高频考点+正确率+薄弱模型） |

#### 一级分类规则
- 知识点Tab和模型Tab的Level 1 **共用同一分类**（如物理都按章：力学/静电场/磁场...）
- 高考卷子Tab的Level 1 按题型分（选择/填空/大题/选做）

#### 跨章节模型处理
- 跨章节模型**在所有相关章节都出现**为节点，点进去是同一详情页
- 节点旁标注小标签"跨: XX章"，数据只存一份

---

## 二、知识点与模型的关系（已确认：双向关联+AI诊断分流）

### 关联方式
- 每个知识点节点标注：`related_models[]`（被哪些模型使用）
- 每个模型节点标注：`required_knowledge_points[]`（需要哪些知识点）
- **不锁定学习顺序**，学生可自由进入任一Tab

### AI诊断分流路径
当学生做错题时，AI通过对话判断错误根源：

| 错误根源 | 判断依据 | 引导路径 |
|---------|---------|---------|
| 粗心/计算 | 学生自述"算错/看错" | 低价值 → 记录 → 周末粗心消杀 |
| 知识点缺口 | AI对话发现不理解基础概念/公式 | 引导到知识点Tab → 知识点学习流程 |
| 模型应用缺口 | 理解概念但不会应用到解题 | 引导到模型Tab → 六步专项训练 |

### 诊断提示词拼接模板
```
学生做错了这道题：{question_summary}
涉及知识点：{related_knowledge_points}
涉及模型：{related_models}
学生历史：
- 知识点掌握情况：{knowledge_mastery}
- 模型掌握情况：{model_mastery}
- 常见错误类型：{common_errors}
请通过最多5轮对话判断错误根源属于以下哪类：
1. 粗心/计算错误
2. 知识点不理解（基础概念/公式/条件不清楚）
3. 模型应用问题（概念懂但不会用来解题），子类：
   a. 识别错（不知道用哪个模型）
   b. 决策错（模型对但公式选错）
   c. 步骤错（公式对但执行出错）
   d. 主语错（公式对但对错了对象/过程）
   e. 代入错（公式结构对但物理量代入错：搞混V₀和V、用错过程的量）
额外检查维度：
- 学生这个式子对谁列的？对哪个过程列的？
- 这个字母代的是哪个物理量？是哪个过程的？（代入错专用）
最大轮数：5轮（快检→追问→深挖→确认→收敛）。5轮后仍无法定位则输出最佳猜测。

⚠️ 诊断结果输出格式（三段式+四层定位，已确认Q54B+Q65C）：
学生目标分数：{target_score}
卷面策略：{exam_strategy}

输出诊断结果时，必须按以下结构：

第一部分：四层逐层定位（Q65C新增）
- 建模层：✅能识别 / ❌卡住（不知用什么模型）
- 列式层：✅能选对公式 / ❌卡住（公式选错）/ ⬜未到达（上一层就卡了）
- 执行层：✅代入计算正确 / ❌卡住（代入错/算错）/ ⬜未到达
- 结论：瓶颈在第X层 → 对应Level X → 训练从Step X开始

第二部分：三段式话术
1. 【定位问题】：具体说明卡在哪一层、错在哪里（精确到子类）
2. 【说明可解决】：这个问题不难 / 你有能力解决（给信心）+ 判断是否"当前可解决"
   - 可解决 = 该层之前的所有层都通过了，只有这一层卡住
   - 暂不可解决 = 前面的层也有问题，需要先解决前面的
3. 【关联目标分数】：解决后对目标分的影响（+X分，关联到具体题号）

示例（瓶颈在执行层）：
"四层诊断：建模✅ 列式✅ 执行❌（代入错）
你的问题出在代入值的时候搞混了V₀和V——公式完全正确，就是哪个V代哪个过程没分清。
这个问题其实不难，因为你前面的建模和列式都是对的，只要列完式子检查一遍'这个字母是谁的'就能解决。
你的目标是70分，大题第一道你必须拿满12分，解决代入问题后这12分你稳拿。"

示例（瓶颈在建模层）：
"四层诊断：建模❌（不知道该用什么模型）
你看到这道题不确定该用能量法还是牛顿第二定律——问题出在过程拆分这一步。
这个也不难，我们先练习怎么判断'这道题有几个过程、每个过程用什么模型'。
你的目标是70分，选择题第5题经常考这个模型，搞定它能稳住3分。"

当前对话历史：{conversation_history}
```

---

## 三、知识点学习流程（已确认：预设内容+AI引导+概念检测）

### 设计原则
- **预设内容是骨架**：教研团队预先制作，保证公式/图示/严谨性
- **AI是个性化调度引擎**：根据学生状态决定讲哪些、跳过哪些、检测题怎么出
- **不涉及AI生成图片/视频**：图示为预设静态图，题库中可含图片

### 每个知识点的预设内容结构
| 模块 | 内容 | 必须 | 示例（电荷量） |
|------|------|:----:|-------------|
| 定义 | 概念的文字定义 | ✅ | "电荷的多少叫作电荷量，用Q或q表示" |
| 公式 | 公式及符号说明 | 可选 | 无 |
| 适用条件 | 使用前提 | 可选 | 无 |
| 注意事项 | 易混淆点、特殊情况 | ✅ | "标量，正值记+Q，负值记-Q" |
| 图示 | 预设静态示意图 | 可选 | 无 |
| 概念检测题 | 2-3道检测题（预设题库中） | ✅ | "以下关于电荷量的说法正确的是..." |

### AI引导工作流（5步）
```
Step 1: AI判断学生对该知识点的当前状态
    ├── 完全陌生 → 进入Step 2（完整流程）
    └── 有基础（从模型诊断分流来的）→ 跳到Step 4（直接检测）

Step 2: 按序呈现预设内容
    定义 → 公式(如有) → 适用条件(如有) → 注意事项 → 图示(如有)
    AI在每个模块间用对话过渡，确认学生理解

Step 3: 关键点确认
    AI针对核心概念提问，确保理解（非做题，而是解释性提问）
    例："用你自己的话说说，电荷量和电荷有什么区别？"

Step 4: 概念检测
    呈现预设的2-3道检测题
    ├── 全对 → Step 5
    └── 有错 → AI针对性讲解薄弱环节 → 再次检测

Step 5: 完成 + 关联推荐 + 自动生成闪卡
    更新知识点掌握度
    **自动生成对应闪卡**（概念卡/条件卡/辨析卡，根据知识点类型选择）
    推荐关联模型："这个知识点在【库仑力平衡模型】中会用到，要去看看吗？"
```

### AI提示词拼接模板（知识点讲解场景）
```
学生进入知识点学习：{knowledge_point_name}
当前掌握状态：{mastery_status}
来源路径：{from_model_diagnosis | self_study | recommendation}
预设内容：{preset_content_json}
学生历史：该知识点关联模型表现{related_model_performance}
请根据学生状态，选择呈现哪些内容模块，以对话方式引导学习。
如果学生已有基础，可跳过已掌握部分直接进入检测。
语气简洁，每次回复不超过3句话。
```

---

## 四、约束条件（已确认）

| 约束 | 说明 |
|------|------|
| 后台算法 | 仅AI提示词拼接，不涉及图片/视频生成 |
| 题库 | 真题 + 本地可靠模拟卷，题库中可有图片 |
| 报告 | 让学生截图 |
| 家长端 | 不做 |
| 知识点/模型讲解 | 有预设好的工作流（知识点=5步引导，模型=六步专项） |

---

## 五、保留自历史版本的核心设计

### 导航架构
- 底部Tab：主页 | 全局(三子Tab) | 记忆 | 社区 | 我的

### 模型训练体系
- 六步专项训练（**过程拆分+识别**→决策→步骤→陷阱→回归→变式）
  - **Step 1(过程拆分+识别)** ：先引导学生拆分运动过程、确定每个过程的主语（研究对象），再穷举可能涉及的模型逐个排除选择（已确认Q39）
  - **Step 2(决策)** ：在已确定的过程+主语下，穷举可用公式逐个排除
  - **Step 5(回归)** 采用**分步骤填空**交互方式：将解题过程拆为3-5步，每步填写关键量/公式/结果；超90秒不输入触发"不敢写"检测（已确认Q40）
- 快速专项、微原子训练、粗心消杀、防腐测试

### 闪卡系统
- **九类卡片**：原六类（识别/决策/步骤/陷阱/公式/变式）+ 新增三类（概念卡/条件卡/辨析卡）
- SM-2间隔复习算法
- 知识点学完后**自动生成**对应闪卡

### 错题闭环（升级版）
- 分诊四路：粗心(细分记录) / 知识点缺口(新增) / 模型不会(高价值) / 审题错(过程拆分)
- 粗心内部细分记录（已确认Q45 A）：计算错 / 符号错 / 审题错 / 抄错，V1仅记录+周复盘提醒，不做专项训练
- 模型应用缺口细分子类（已确认Q37 B + Q55B）：
  - 识别错（不知道用哪个模型）
  - 决策错（模型对但公式选错）
  - 步骤错（公式对但执行出错）
  - **主语错**（公式对但对错了对象/过程）
  - **代入错**（公式结构正确但物理量代入错误：搞混V₀和V、张冠李戴不同过程的量）← 新增Q55B
- AI诊断提示词中增加检查维度："学生这个式子对谁列的？对哪个过程列的？""这个字母代的是哪个物理量？是哪个过程的？"

### 其他
- 小队机制、社区投票、周任务、推送规则等保持原设计

---

## 六、知识点掌握度（融合四层诊断，Q63重构）

### 核心变更
> **旧版**L1="发现薄弱"、L2="多次薄弱"——只区分错几次，不区分错在哪。
> **新版**L1/L2/L3直接编码"卡在知识掌握的哪一层"——自动决定训练方向，家长也能看懂。

| Level | 状态 | 含义（瓶颈在哪） | 升级条件 | 降级条件 | 对应训练 |
|-------|------|----------------|---------|---------|---------|
| 0 | **未接触** | 从没学过 | 初始状态 | — | — |
| 1 | **记不住** | 公式/概念回忆不出来 | recall失败 or AI暴露记忆缺口 | — | 闪卡+重新呈现(Step 2) |
| 2 | **理解不深** | 能回忆但说不清为什么/条件不清 | 能recall但解释失败 or 条件检测错 | — | AI讲解+条件检测(Step 3-4) |
| 3 | **使用出错** | 理解了但在题目中用错（辨析不清） | 能解释但检测题用错 | — | 辨析训练+概念检测(Step 4) |
| 4 | **能正确使用** | 检测正确+能解释 ≥ 1次 | 检测对+解释对 | 做错→退回出错的层(L1/L2/L3) |
| 5 | **稳定掌握** | 延时复测通过(≥24h间隔) ≥ 2次 | 多次正确(间隔≥24h) | 解释出错 → L4 |

### 知识点的三层含义（给家长/学生看的）
| 层 | 能力 | 家长看得懂的话 |
|----|------|--------------|
| 记忆层(L1) | 能不能回忆出公式/概念 | "记不住这个公式" |
| 理解层(L2) | 能不能解释为什么、什么条件下能用 | "记住了但说不清为什么" |
| 使用层(L3) | 在题目中能不能正确使用 | "懂了但做题还是用错" |

### "不同时间"的定义（全局适用）
- **间隔≥24小时** = 两次操作的时间戳相差 ≥ 86400秒
- 适用于所有"不同时间"要求的升级条件（知识点L5、模型L5）

### 公式/概念recall测试（Q67C：自适应recall→recognition）
```
目的：判断学生是否记住公式/概念（L1→L2的关键验证）

首次测试 = 开放式recall（真正测记忆）：
- 提示："这个模型的核心公式是什么？请写出来"
- 学生打字输入
- AI判定：短prompt判断是否正确（~0.001元/次，10次≈1分钱）
- 优势：测的是真记忆，不是"看到选项觉得对"

后续测试 = 根据上次结果自适应：
├── 上次recall成功 → 继续recall（保持高标准）
├── 上次recall失败 → 切换到多选recognition（降低门槛，先建立初步记忆）
│   └── recognition连续2次正确 → 下次切回recall验证
└── recall失败≥3次 → 触发"记忆辅助"（公式拆解+记忆口诀+闪卡强化）

成本：recall判定极低，~0.001元/次（prompt很短："学生写了X，正确答案是Y，判断对错"）
recognition = 0成本（纯规则匹配预设选项）
```

### "能解释"的操作方式（保持不变）
- 通过概念检测后，AI追问1道预设的开放题
- 例："用你自己的话说说，为什么库仑定律只适用于点电荷？"
- 学生打字回答，AI按预设答案要点判定
- 每个知识点预设1-2道解释题 + 答案要点

---

## 七、概念检测触发时机（已确认：4个场景全做）

| 场景 | 触发条件 | 流程 | 掌握度影响 |
|------|---------|------|-----------|
| A. 主动学习 | 学生在知识点Tab点进某知识点 | 完整5步工作流，Step 4 | 正常升级 |
| B. 诊断分流 | 错题→AI判断知识点缺口→引导 | 跳到Step 4检测，没过回Step 2 | 没过→L1；过了→L3+ |
| C. 模型训练中暴露 | 六步专项中发现基础概念不会 | 插入1道快检确认 | 没过→知识点L1 |
| D. 周复盘防腐 | 每周对已掌握知识点抽检 | 1-2道快检 | 没过→降级 |

---

## 八、模型掌握度（融合四层诊断，Q63重构）

### 核心变更
> **旧版**L1="发现问题"、L2="多次错"——只区分错几次，不区分错在哪。
> **新版**L1/L2/L3直接编码"卡在解题的哪一步"——每个Level自带训练方向，降级精确到出错的层（不再一律回L1）。

| Level | 状态 | 含义（瓶颈在哪） | 升级条件 | 降级条件 | 对应训练 |
|-------|------|----------------|---------|---------|---------|
| 0 | **未接触** | 从没做过这个模型 | 初始状态 | — | — |
| 1 | **建模卡住** | 过程拆不对/不知道用什么模型 | AI诊断=识别错 | — | Step 1(过程拆分+识别) |
| 2 | **列式卡住** | 能识别模型但公式选错/列不对式子 | 识别通过但公式选择失败 | — | Step 2(公式选择+穷举排除) |
| 3 | **执行卡住** | 公式对但代入错/主语错/算错 | 公式对但执行出错 | — | Step 3-5(步骤+代入+计算) |
| 4 | **做对过** | 全流程至少做对1次 | Step 5回归题做对 ≥ 1次 | 做错→退回出错的层(L1/L2/L3) |
| 5 | **稳定掌握** | 变式+延时复测均通过 | Step 6变式对+延时复测通过(间隔≥24h) | 做错 → L4 |

### 模型的四层含义（给家长/学生看的）
| 层 | 能力 | 家长看得懂的话 | 对应错误子类 |
|----|------|--------------|------------|
| 建模层(L1) | 看到题能不能判断用什么方法、拆对过程 | "不知道这道题该用什么方法" | 识别错 |
| 列式层(L2) | 知道方法后能不能选对公式、列对式子 | "知道方法但公式选不对" | 决策错 |
| 执行层(L3) | 公式对了能不能代对值、算对数 | "公式对了但算不对" | 步骤错/代入错/主语错/计算粗心 |
| 稳定层(L4→L5) | 做对一次后隔段时间还能不能做对 | "做对过但过段时间又不行了" | — |

### 升降级详细规则
```
首次接触某模型：
├── 做对了 → 直接L4（跳过L1-L3，因为L1-L3描述的是"卡住"状态）
└── 做错了 → AI诊断定位层次：
    ├── 识别错(不知用什么模型) → L1
    ├── 决策错(公式选择层面) → L2
    └── 步骤错/代入错/主语错/计算错 → L3

升级路径（每升一级 = 突破一层瓶颈）：
L1 → L2：Step 1训练通过（能识别了），但Step 2失败（公式还不行）
L1 → L4：Step 1通过 + 后续全通过 → 直接跳到L4（可以跨级）
L2 → L3：Step 2训练通过（能选对公式），但Step 3-5失败（执行还不行）
L2 → L4：Step 2通过 + 后续全通过 → 直接跳到L4
L3 → L4：Step 5回归题做对（全流程通过1次）
L4 → L5：Step 6变式对 + 延时复测通过（间隔≥24h，≥2次）

降级规则（精确降级，不再一律回L1）：
L4/L5 做错时：
├── AI诊断=识别层出错 → 降到L1
├── AI诊断=列式层出错 → 降到L2
├── AI诊断=执行层出错 → 降到L3
└── 降级下限：L1（不降到L0，L0=从没接触过）

其他触发规则：
- 升级只在训练流程内触发：Step 5对→可能升到L4，Step 6对→可能升到L5
- 降级可由任何"做错"触发：训练内做错、每日上传标错、考试卷子标错
- 快检识别错 → 降到L1（识别层出错）
- 不稳定标记：不影响level本身，只影响预测算法的权重
- 上传标"对"：只更新last_active，不改current_level
```

### 延时复测机制（Q66）
```
L4做对后，自动安排延时复测（变式题，不是原题）：

第1次复测：3天后
├── 通过 → 继续L4，安排第2次
└── 失败 → 降到出错的层(L1/L2/L3)，重新训练

第2次复测：7天后
├── 通过 → 继续L4，安排第3次
└── 失败 → 同上

第3次复测：30天后
├── 通过 → 升级到L5（稳定掌握）
└── 失败 → 同上

复测形式：
- 用变式题（同一模型换场景/数值，防止记住答案）
- 1道题，约2-3分钟
- AI可截断到特定层（如只测识别 → 快检形式）
- 成本：预设变式题=0成本；AI生成变式=~0.05元/次

为什么用变式不用原题（来自课堂洞察）：
"看完答案觉得会了 ≠ 隔段时间真的会了"——原题复测只测记忆，变式复测才测理解。
```

### 模型掌握度 vs 知识点掌握度对比（统一框架）
| Level | 模型（解题能力） | 知识点（理解能力） | 共同点 |
|-------|----------------|------------------|--------|
| 0 | 未接触 | 未接触 | 从没碰过 |
| 1 | **建模卡住**（不知用什么模型） | **记不住**（概念回忆不出） | 最基础的层面出问题 |
| 2 | **列式卡住**（公式选不对） | **理解不深**（说不清为什么） | 中间层面出问题 |
| 3 | **执行卡住**（代入/计算错） | **使用出错**（题中用错） | 应用层面出问题 |
| 4 | **做对过**（全流程通过1次） | **能正确使用**（检测+解释对） | 至少成功1次 |
| 5 | **稳定掌握**（变式+延时通过） | **稳定掌握**（延时通过） | 持续可靠 |

> **统一原则**：L1-L3不再是"错几次"的计数，而是"错在哪一层"的定位。每个Level自带训练方向，家长也能看懂"孩子卡在哪"。

---

## 九、高考卷子Tab（已确认：真题展示+上传卷子）

### 核心功能
- 支持**上传整张卷子**（拍照→AI切分题目→自动归入对应题号）
- 显示学生**做过的卷子**中切分出的题目
- 按高考题号结构聚合统计

### 三级结构
| Level 1 | Level 2 | Level 3 |
|---------|---------|---------|
| 题型（选择题1-8 / 实验题 / 计算题 / 选做题） | 题号（第3题） + 聚合统计 | 该题号下学生做过的具体题目列表 |

### Level 2 展示内容（题号聚合页）
- 累计做题数
- 个人正确率
- 高频考点标签
- 薄弱知识点/模型标签

### Level 3 展示内容（具体题目列表）
- 来源卷子名称
- 对错状态
- 点击可查看题目详情 → 可进入错题诊断

### 上传入口（已确认：统一"+"按钮，见第三十节）
- 高考Tab仍保留独立上传入口（便于在Tab内直接操作）
- 主页"+"按钮同样可选择上传考试卷子（路由到高考Tab处理流程）

---

## 十、主页结构（已确认）

### 主页区域
| 区域 | 内容 |
|------|------|
| **"+"按钮** | 点击展开3个选项（见第三十节） |
| **推荐区** | 混合推荐"知识点补强"+"模型训练"+"待诊断错题"，带理由标签 |
| **快速开始** | 一键进入最高优先级任务（按推荐排序算法第1名） |
| **预测中心入口** | 卡片"查看我的分数预测 →" |
| **今日/本周数据** | 闭环数、学习时长 |
| **上传历史入口** | "最近上传 →" 进入统一历史页 |

### 主页推荐排序算法（Q81重写：完整数据追溯版）

#### 核心决策逻辑
> **一句话**：学生时间有限，每次推荐 = "花接下来20分钟做什么，预计能多拿几分？"
> **公式**：`优先级 = (提分影响 + 依赖加成) × 紧迫系数 × 新鲜系数 / 所需时间`

#### 候选池（6种来源）
```
Type A: 待诊断错题
  来源：diagnosis_status == pending 的题目
  为什么最优先：不诊断就不知道错在哪层 → 后续推荐全基于不准确数据
  
Type B: 模型训练
  来源：current_level 1-3 的模型（有明确瓶颈需要训练的）
  
Type C: 知识点学习
  来源：current_level 1-3 的知识点

Type D: 到期的延时复测
  来源：current_level == 4 且 next_retest_date ≤ today 的模型
  为什么紧急：复测有时间窗口，错过要重新排期

Type E: 冷启动探索（仅首周）
  来源：peak_level == 0 且 exam_strategy == 🔴 的模型，且注册 ≤ 7天
  
Type F: 遗忘保护
  来源：current_level ≥ 4 且 last_active > 14天 的模型/知识点
```

#### 优先级分层（Tier 0 > Tier 1 > Tier 2 > Tier 3）
```
Tier 0（必须今天做 — 有时间窗口）：
  到期的延时复测（Type D）
  展示："⏰ 今天有1个复测到期：板块运动"
  最多显示：1条（放在推荐列表最顶部）

Tier 1（应该先做 — 信息阻塞）：
  待诊断错题（Type A）
  展示："📋 你有X道待诊断错题"
  排序：最近上传的优先
  最多显示：2条

Tier 2（核心推荐 — 提分优化）：
  模型训练（Type B）+ 知识点学习（Type C）
  排序：按 priority_score 从高到低（见下方计算）
  展示：模型名 + 理由标签 + "预计+X分" + "约Y分钟"
  最多显示：3-5条

Tier 3（补充推荐 — 探索/维护）：
  冷启动探索（Type E）+ 遗忘保护（Type F）
  展示："与你目标分相关，建议测一下" / "14天没练了"
  最多显示：1-2条
```

#### Tier 2 核心算法：priority_score 计算
```
对于候选模型/知识点 M：

Step 1: 计算 score_impact（提分影响）
  // 查找所有"M是必需项"的高考题号
  affected_questions = question_map中包含M的所有题号
  
  score_impact = 0
  对于每个 affected_question Q:
    current_prob = level_to_prob[M.current_level]
    next_prob = level_to_prob[M.current_level + 1]
    
    // 木桶原则：M是不是这道题的短板？
    other_probs = Q中其他所有required_model和required_kp的level_to_prob值
    min_other = min(other_probs) 如果有的话，否则 1.0
    
    如果 current_prob <= min_other:
      // M就是短板（或并列最短）→ 提升M能直接提分
      improvement = (min(next_prob, min_other) - current_prob) × Q.max_score
    否则:
      // M不是短板 → 提升M对这道题没用（别的更弱）
      improvement = 0
    
    score_impact += improvement

  数据来源：
  ├── M.current_level → Section二十九后端标签
  ├── level_to_prob → Section五十二预测算法
  ├── question_map → 教研预设（题号→所需模型/知识点+满分）
  └── 其他模型/知识点的level → 同一学生的后端标签

Step 2: 乘以 urgency_factor（紧迫系数）
  // 这个模型关联的最重要的题号是什么态度？
  attitudes = [exam_strategy[Q.题号].attitude for Q in affected_questions]
  most_urgent = max(attitudes)  // 🔴 > 🟡 > ⚪
  
  urgency_factor = {🔴必须拿满: 3.0, 🟡争取: 1.5, ⚪可放弃: 0.3, 无策略: 1.0}
  
  数据来源：exam_strategy → Section十四卷面策略表

Step 3: 估算 time_cost（所需时间，分钟）
  模型：
    L0(新学): 45min（Step 1-5完整流程）
    L1→L2: 25min（Step 1训练）
    L2→L3: 35min（Step 2训练）
    L3→L4: 20min（Step 3-5训练）
  知识点：
    L0(新学): 20min（5步完整流程）
    L1→L2: 10min（recall+重新呈现）
    L2→L3: 15min（讲解+条件检测）
    L3→L4: 10min（概念检测+辨析）
  
  数据来源：教研经验估值（后续可用实际训练时长数据校准）

Step 4: 加上 dependency_boost（依赖加成）
  // 如果M是其他模型的前置依赖，提升M能解锁后续模型
  blocked_downstream = 在model_prerequisites中，
    以M为前置条件 且 那个下游模型的current_level < 4 的数量
  
  dependency_boost = blocked_downstream × 0.5（分）
  
  数据来源：model_prerequisites → Section五十一教研预设

Step 5: 乘以 freshness_factor（新鲜系数）
  // 刚做过的不要连续推，给点变化
  如果 M.last_active 在24小时内: freshness = 0.5
  否则: freshness = 1.0
  
  数据来源：M.last_active → 后端标签

Step 6: 最终 priority_score
  priority_score = (score_impact + dependency_boost) × urgency_factor × freshness / time_cost
  
  单位：分/分钟（每花1分钟预计提多少分）
  示例：score_impact=2.5分, urgency=3.0(🔴), time=25min, no dependency, fresh
        → priority = 2.5 × 3.0 × 1.0 / 25 = 0.30 分/分钟
```

#### 推荐项展示格式
```
每条推荐显示：
├── 名称：模型名/知识点名/题目预览
├── 理由标签：
│   ├── Tier 0: "⏰ 复测到期"
│   ├── Tier 1: "📋 待诊断"
│   ├── Tier 2: "🔴 目标分关键" / "提分最快" / "本周错2次"
│   └── Tier 3: "建议测一下" / "14天没练了"
├── 预计提分："预计+2.5分"（来自score_impact计算）
├── 预计耗时："约25分钟"（来自time_cost估算）
└── 点击后动作：进入对应训练/诊断/复测流程

⚠️ "预计+X分"只在Tier 2显示（有足够数据计算时）
Tier 0/1/3 只显示理由标签和耗时
```

#### 特殊规则
```
1. 跨模型依赖过滤：
   如果模型B的前置依赖A的current_level < 4 → B不出现在Tier 2
   （但A会因为dependency_boost获得加成）

2. 不稳定模型优先：
   is_unstable == true 的模型 → urgency_factor额外 ×1.5
   理由：不稳定=时对时错，高考随机性大，需要优先稳定

3. 同一模型不重复：
   如果一个模型同时满足Tier 1(待诊断)和Tier 2(训练) → 只出现在Tier 1
   
4. 每日推荐缓存：
   每天凌晨计算一次完整推荐列表并缓存
   学生完成一项后，实时重算（删掉已完成的，可能冒出新的）
   
成本：0（全部是规则层计算，不调大模型）
```

### 首周冷启动推荐策略（已确认Q59B）
```
注册诊断只测约10道题，大量模型仍为L0。首周推荐策略：

候选池扩展（仅首周生效，注册后7天内）：
1. 诊断暴露的薄弱模型（正常推荐，最高优先）
2. 🔴必须拿满 关联但未被诊断覆盖的模型（新增来源）
   └── 理由标签："与你目标分相关，建议了解一下水平"
   └── 点击后：先走快检（1题30秒）了解水平 → 根据结果路由
3. 常规候选池（待诊断错题/不稳定模型/久未练习）

触发条件：
├── 注册完成后 ≤ 7天
├── 🔴关联模型中 peak_level == 0 的（完全未接触）
└── 每天推荐中穿插1-2个未测模型（不强制清单，自然穿插）

7天后：
└── 自动退出冷启动模式，回归正常推荐逻辑
```

---

## 十一、每日闭环定义（已确认）

- 闭环**仅算**：错题分析 / 刷题
- 知识点学习**不算**闭环（是解决环节的一部分）

### 闭环计数规则
```
+1闭环的条件（满足任一即可）：
├── 完成一道错题的AI诊断 + 进入对应训练
├── 完成一次模型训练（走完至少到Step 5）
├── 完成一次粗心消杀（重做粗心错题并做对）
└── 完成一次审题训练

不计闭环的：
├── 知识点5步学习（属于训练的组成部分，不单独计）
├── 闪卡复习（属于巩固环节，独立统计在"记忆"Tab）
├── 仅上传但未诊断的错题
└── 快检（属于路由环节，不是训练）
```

---

## 十二、模型详情页（已确认：增加前置知识点+智能提示）

- 现有内容保留：状态 + 错误次数 + 相关题目 + [开始学习] + [做题测试]
- **新增**：前置知识点区域，显示关联知识点及其掌握度
- **新增**：如果有关联知识点未掌握，显示"建议先学习XX"（不强制）

---

## 十三、V1版本内容范围（已确认）

| 项目 | 范围 |
|------|------|
| 学科 | 物理 + 数学 |
| 章节 | 全部章节 |
| 内容 | 所有知识点 + 所有模型/方法 |

> 数据库内容由教研团队保证

---

## 十四、注册流程（已确认Q52B+Q53B：目标分数→卷面策略→自适应诊断）

### 注册三步走

| 步骤 | 内容 | 时长 | 成本 |
|------|------|------|------|
| Step 1 | 基础信息 + 目标裸分 | 2分钟 | 0 |
| Step 2 | 系统生成卷面策略 | 即时 | 0（纯规则） |
| Step 3 | 自适应AI诊断 | 15-30分钟 | ~1-1.5元 |

### Step 1: 基础信息 + 目标分数
- 选择省份/城市 → 系统加载对应**地区卷面结构模板**（教研预设，见Section四十六）
- 输入目标裸分（例：70分）
- 可选：自述当前水平（"大概考多少"）

### Step 2: 卷面策略生成（纯规则，0成本）
```
输入：target_score + regional_exam_structure

策略生成逻辑：
1. 从最难题开始分配"允许扣分"额度
2. 对每个题号/区域标注态度：
   - 🔴必须拿满：与目标分直接挂钩的基础题
   - 🟡争取拿分：中等难度，争取部分得分
   - ⚪可放弃/拿基础分：超出目标分所需的难题

3. 输出卷面策略表（示例：目标70分/总分100分）：
   | 题号/区域 | 满分 | 目标得分 | 态度 | 说明 |
   |---------|------|---------|------|------|
   | 选择1-6 | 18分 | 18分 | 🔴必须拿满 | "这些你绝对能做到" |
   | 选择7-8 | 6分 | 3分 | 🟡争取 | "多选题稳选一半" |
   | 实验题 | 15分 | 10分 | 🟡争取 | "基础实验必拿" |
   | 大题1 | 12分 | 12分 | 🔴必须拿满 | "你有能力写出来" |
   | 大题2 | 14分 | 10分 | 🟡争取 | "前两问必做" |
   | 大题3 | 18分 | 5分 | ⚪基础分 | "写已知+第一步" |
   | 选做题 | 15分 | 12分 | 🔴必须拿满 | "选做题相对简单" |

4. 关键话术展示：
   "你想考70分 → 选择题最多错2个，大题前两道必须拿满。
   这些你是做得到的，并不难。"
```

### Step 3: 自适应AI诊断（替代原静态问诊）
```
替代原"5选择+5大题"或"10选择+解释"的静态问诊。

流程：
1. AI先对话了解基础情况（1-2轮）：
   - "你觉得哪些章节最薄弱？"
   - "计算准确率怎么样？"

2. 根据卷面策略中🔴必须拿满的题号，提取关联模型，优先测试：
   - 每个关键模型出1道简单题（测公式记忆+基本应用）
   - 动态调整下一题：
     ├── 做对且快 → 跳过，测下一个模型
     ├── 做对但慢/犹豫 → 追问概念确认
     └── 做错 → 追问定位错误层次（公式不会/概念混/会列不会算）

3. 输出三维度初始画像：
   - formula_memory_rate: 公式记忆度（能记住多少关键公式）
   - model_identify_rate: 模型识别力（能否判断该用什么方法）
   - calculation_accuracy: 计算准确度（基本计算是否可靠）

4. 初始化标签（适配融合后的L0-L5，Q63重构）：
   ├── 每道诊断题关联的模型（Level直接编码瓶颈层）：
   │   ├── 做对 → current_level=4, peak_level=4 （L4=做对过，全流程通过）
   │   ├── 做错(不知道用什么模型/过程拆不对) → current_level=1, peak_level=1 （L1=建模卡住）
   │   ├── 做错(知道方法但公式选错) → current_level=2, peak_level=2 （L2=列式卡住）
   │   └── 做错(公式对但代入错/算错) → current_level=3, peak_level=3 （L3=执行卡住）
   ├── 关联知识点：不受问诊影响（日常积累）
   └── 全局画像标签初始化（formula_memory_rate / model_identify_rate / calculation_accuracy）

所有未覆盖的模型保持 current_level = 0, peak_level = 0。
```

### 诊断完成后的结果展示
- 结合三段式话术（见Section二 AI诊断结果输出格式）
- 示例："你想考70分，选择题你需要基本全对。目前你的XX模型不够稳定，这是首先要攻克的——解决它预计能帮你+5分"

### 卷面策略展示时机
- 注册完成后：主页卡片"我的目标：XX分 → 查看卷面策略"
- 每次诊断结果中：关联目标分数影响
- 周复盘时：对比当前预测分 vs 目标分
- 学生可随时修改目标分数 → 策略自动重新生成（见下方"目标分数变更处理"）

### 目标分数变更处理（已确认Q58C）
```
学生修改目标分（例：70→80）时触发：

1. 系统自动重算卷面策略表（纯规则，0成本）
   - 重新分配"允许扣分"额度
   - 更新所有题号的态度标签（🔴🟡⚪可能变化）

2. 弹出"目标变更引导"弹窗：
   - 展示新旧目标的具体差异
   - 指出新目标需要额外稳住哪些题号
   - 示例："从70分到80分，你还需要额外稳住选择第7题和大题第2题第3问。
          这两个题涉及的模型是XX和YY，你目前掌握度分别是L2和L3。"

3. 主页推荐自动按新策略重排
   - 新变为🔴的模型如果level低 → 直接进推荐Top 3
   - 原来🔴现在变🟡的模型 → 推荐优先级降低
```

---

## 十五、闪卡系统扩展（已确认：Q16+Q18）

### 卡片类型（共9种）

#### 原有6种（模型训练闪卡）
| 类型 | 正面 | 背面 | 来源 |
|------|------|------|------|
| 识别卡 | 题目描述/关键词 | 对应模型名称 | Step 1 |
| 决策卡 | 模型名+场景 | 选择哪个公式/方法 | Step 2 |
| 步骤卡 | 模型名 | 解题步骤序列 | Step 3 |
| 陷阱卡 | 常见错误描述 | 正确做法 | Step 4 |
| 公式卡 | 公式名称/适用场景 | 公式内容 | 通用 |
| 变式卡 | 变式题描述 | 核心不变的方法 | Step 6 |

#### 新增3种（知识点闪卡）
| 类型 | 正面 | 背面 | 生成时机 |
|------|------|------|---------|
| **概念卡** | 概念名称 | 定义+关键属性 | 知识点学完自动生成 |
| **条件卡** | 公式/定律名称 | 适用条件+限制 | 知识点学完自动生成 |
| **辨析卡** | 两个易混概念 | 区别+判断方法 | 知识点学完自动生成 |

### 自动生成规则
- 知识点学习流程（5步）完成后，系统**自动**生成对应闪卡
- 模型训练每步完成后，系统**自动**生成对应闪卡（Step 1→识别卡，Step 2→决策卡...）
- 易混模型对比表展示后，**自动**生成辨析卡
- 根据知识点类型选择卡片：概念类→概念卡，公式类→条件卡，易混淆→辨析卡
- 学生可手动删除不需要的卡片

### SM-2间隔复习算法
```
每张卡片维护：
- ease_factor: float (初始2.5, 最小1.3)
- interval: int (天数, 初始1)
- repetitions: int (连续答对次数)

学生回答后：
├── 答对（"记得"/"简单"）：
│   ├── repetitions += 1
│   ├── 如果 repetitions == 1 → interval = 1
│   ├── 如果 repetitions == 2 → interval = 6
│   ├── 否则 → interval = round(interval × ease_factor)
│   └── ease_factor += 0.1 (答"简单"时), 不变(答"记得"时)
│
└── 答错（"忘了"）：
    ├── repetitions = 0
    ├── interval = 1（重新开始）
    └── ease_factor = max(1.3, ease_factor - 0.2)

下次复习时间 = 当前时间 + interval天
```

> SM-2是成熟的开源算法，直接使用即可。关键是闪卡的**内容质量**（由教研+自动生成保证）。

---

## 十六、六步闭环架构（已确认：Q10a B 半显性）

### 完整闭环
```
发现问题 → 诊断原因 → 针对训练 → 验证掌握 → 巩固防忘 → 复盘升级
   ↑                                                          |
   └──────────────────── 循环 ←─────────────────────────────────┘
```

### 各步对应系统模块
| 闭环步骤 | 系统模块 | 触发方式 |
|---------|---------|---------|
| 发现问题 | 做题错误 / 每日上传 / 主动学习 / 测试 / 周复盘 | 多入口自然触发 |
| 诊断原因 | AI诊断5轮（粗心/知识点/模型） | 自动跟随发现 |
| 针对训练 | 知识点5步 / 模型6步 / 粗心纠偏 | AI分流 |
| 验证掌握 | 概念检测 / Step 5填空 / 变式题 | 训练完自动触发 |
| 巩固防忘 | 闪卡自动生成 + 间隔复习 + 每日上传监控 | 验证通过后自动 |
| 复盘升级 | 周复盘页 + 预测系统 + 策略调整 | 每周自动 |

### 显性化策略：半显性（B）
- **日常使用**：学生只看到"今天做什么"，闭环逻辑在后台自动运转
- **周复盘页**：展示闭环数据，如"本周完成3个模型闭环（训练→验证→巩固）"
- 教练在后台控制流程，每周出一次训练报告

### 知识点解决方案（已确认：Q10b B 统一流程动态调）
- 不管是"没学过""学过忘了""概念模糊"，都走同一个5步流程
- **路由层（纯规则）** 根据标签决定入口和跳转

### 系统两层架构（已确认：Q35）
| 层 | 职责 | 实现方式 | 成本 |
|----|------|---------|------|
| **路由层** | 决定从哪步开始、跳到哪步 | 纯规则（if-else），读标签值 | 0 |
| **对话层** | 在某步内与学生互动（讲解/提问/判定） | 大模型prompt拼接调用 | ~0.1元/次 |

### 知识点5步路由规则
```
入口判断（规则层，不调大模型）：

第一层：判断是否学过
├── peak_level == 0 → 完全新学
│   ├── conclusion_level == 1 → 完整5步（Step 1→2→3→4→5）
│   └── conclusion_level == 2 → 简化3步（Step 1→2简要→4使用条件→5闪卡）
│
├── peak_level > 0 && last_active > 14天 → 久未练习
│   └── 入口=Step 4（概念检测）
│       ├── 检测对 → Step 5
│       └── 检测错
│           ├── conclusion_level == 1 → 退回Step 2（完整重学）
│           └── conclusion_level == 2 → 退回Step 2简要 + Step 4
│
├── current_level == 1 → 记不住（记忆层薄弱）
│   └── 入口=Step 2（重新呈现内容+记忆训练）
│       └── 完成后 → Step 4（概念检测）
│
├── current_level == 2 → 理解不深（理解层薄弱）
│   └── 入口=Step 3（关键点确认+条件讲解）
│       └── 完成后 → Step 4（概念检测）
│
├── current_level == 3 → 使用出错（使用层薄弱）
│   └── 入口=Step 4（概念检测+辨析训练）
│       ├── 检测对 → Step 5
│       └── 检测错 → 根据错误定位层：记忆层错→退回Step 2，理解层错→退回Step 3
│
└── current_level >= 4 → 已有基础
    └── 入口=Step 4（检测验证）
        ├── 检测对 → Step 5
        └── 检测错 → 根据错误定位层→降级到对应Level→退回对应Step
```

### 模型6步路由规则（适配融合后的L0-L5，Q63重构）
```
入口判断（规则层，不调大模型）：
⚠️ 按优先级从上到下匹配，命中第一条即停止
⚠️ 核心原则：Level直接编码了瓶颈层，Level就是入口

优先级1：从没学过
├── peak_level == 0 → 入口=Step 1（完整流程，含过程拆分教学）

优先级2：做错题分流进来（已有诊断结果）
├── 来源=做错题分流
│   ├── 诊断=识别错 → 入口=Step 1（建模层训练）
│   │   └── 若reading_accuracy<0.6 → 先插入1道审题训练再进Step 1
│   ├── 诊断=决策错 → 入口=Step 2（列式层训练）
│   └── 诊断=步骤错/代入错/主语错/计算错 → 入口=Step 3（执行层训练）
│   （注：做错题进来不走快检，已有错误信息可直接定位到层）

优先级3：久未练习（非做错题场景）
├── peak_level > 0 && last_active > 14天 → 快检（见Section四十三）
│   ├── 快检通过 → Step 5（回归验证）
│   │   ├── 验证对 → Step 6（变式） → 进入延时复测队列
│   │   └── 验证错 → AI诊断定位出错的层 → 进对应Step
│   └── 快检不通过 → current_level降到L1 → Step 1

优先级4：正常路由（Level即入口，不再需要weak_step）
├── current_level == 1 → 入口=Step 1（建模层：过程拆分+模型识别）
├── current_level == 2 → 入口=Step 2（列式层：公式选择+穷举排除）
├── current_level == 3 → 入口=Step 3（执行层：代入+计算+检查）
├── current_level == 4 → 入口=Step 5（回归验证）
│   ├── 验证对 → Step 6（变式） → 进入延时复测队列
│   └── 验证错 → AI诊断定位出错的层 → 降级到对应Level → 进对应Step
└── current_level == 5 → 入口=Step 6（变式/延时复测）
    └── 做错 → 降到L4 → 下次进Step 5

注意：旧版的"weak_step"概念已废弃。
新版中Level本身就编码了最弱步骤：L1=卡在Step 1, L2=卡在Step 2, L3=卡在Step 3-5。
不需要额外字段记录"上次最弱步骤"。
```

### 成本估算
- 知识点学习一次：3-5次大模型调用（0.3-0.5元）
- 模型训练一次：4-6次大模型调用（0.4-0.6元）

### 首次学模型验证题（已确认：Q10c A 预设母题）
- 每个模型预设1-2道**母题**（该模型最典型的题型）
- 首次学习时，Step 5用母题做验证
- 非首次学习时，Step 5用学生之前的错题

---

## 十七、Tab改名（已确认："全局"）

### 底部导航栏
```
主页 | 全局 | 记忆 | 社区 | 我的
```

- "全局"强调学科学习的全景视图
- 进入后看到三个子Tab：知识点 / 模型方法 / 高考卷子视角

---

## 十八、知识点详情页（已确认：Q13 状态仪表盘+学习入口）

### 页面内容
| 区域 | 内容 |
|------|------|
| **掌握度** | 当前Level（0-5）+ 一级/二级结论标签 |
| **学习入口** | [开始学习] → 进入5步AI引导流程 |
| **概念检测记录** | 历史检测：时间+对错+AI评语 |
| **关联模型** | 所有使用该知识点的模型列表 + 各模型掌握度，可点击跳转 |
| **标签区** | 一级/二级结论、`peak_level`（曾达到最高Level） |

### 不放的东西
- ❌ 不放题目列表（题目归属于模型，不归属于知识点）
- ❌ 不放错题（通过"关联模型"间接呈现）
- ❌ 不放做对的题（同上）

> 知识点页的职责 = 证明"你掌握到什么程度了" + 提供学习入口

---

## 十九、模型训练交互细化（已确认：Q17+Q27）

### 6步每步的交互方式和判定逻辑

| Step | 名称 | 交互方式 | AI判定方式 | 成本 |
|------|------|---------|-----------|------|
| 1 | 过程拆分+识别 | AI给题→学生拆过程+选主语+选模型 | 规则匹配预设答案 | ~0.1元 |
| 2 | 决策 | 显示可用公式列表→学生排除选择 | 规则匹配 | ~0.1元 |
| 3 | 步骤 | AI讲解标准解题步骤，学生确认理解 | AI对话确认 | ~0.1元 |
| 4 | 陷阱 | AI展示该模型常见错误→学生判断对错 | 规则匹配预设陷阱 | ~0.1元 |
| 5 | 回归 | 分步骤填空（3-5步） | AI逐步判定+即时反馈 | ~0.1元 |
| 6 | 变式 | 给变式题→学生完整解答 | AI判定 | ~0.1元 |

### Step 1 识别 + Step 2 决策：选项穷举训练
- Step 1 先引导学生拆分过程+确定主语，再展示"这道题可能涉及的3-4个模型"让学生排除选择
- Step 2 展示"这个步骤有哪些公式可用"，逐个排除确定
- 核心逻辑：**穷举所有选项 → 逐个排除 → 锁定正确路径**
- 来自课堂洞察：老师花最多时间教的就是"你有哪些选项，为什么选这个"

### Step 3 步骤 + Step 4 陷阱
- Step 3：AI按预设步骤讲解该模型的标准解题流程，每步让学生确认"明白了"
- Step 4：AI展示该模型的2-3个常见错误（教研预设），让学生判断"这里哪里错了"
- 两步都有预设内容骨架，AI做个性化对话过渡

### Step 5 回归：分步骤填空交互
- 将一道原题的解题过程拆为3-5步
- 每步学生填写：关键物理量 / 选用公式 / 计算结果
- AI实时判定每步对错，错误步骤立即反馈
- 超90秒不输入→触发"不敢写"检测（见Section三十四）
- 比"重新做一遍整题"更聚焦，比"看答案"更有参与感

### AI提示词拼接模板（模型训练场景）
```
学生进入模型训练：{model_name}
当前步骤：Step {step_number}（{step_name}）
学生模型掌握度：current_level={current_level}, peak_level={peak_level}
来源路径：{from_error_diagnosis | self_study | quick_check | recommendation}
诊断结果（如有）：{error_subtype}
不稳定标记：{is_unstable}

预设内容：
- 可选模型列表（Step 1用）：{candidate_models}
- 可用公式列表（Step 2用）：{candidate_formulas}
- 标准步骤（Step 3用）：{standard_steps}
- 常见陷阱（Step 4用）：{common_traps}
- 分步填空题（Step 5用）：{fill_in_steps}
- 变式题（Step 6用）：{variant_question}

人格设定：{personality_prefix_training}
对话历史：{conversation_history}

规则：
1. 语气简洁严格，不放水
2. 每次回复不超过3句话
3. 如果学生是"主语错"进来的，Step 1重点引导"对谁列式？对哪个过程？"
4. 如果is_unstable==true，增加追问深度（比常规多问1轮确认）
```

---

## 二十、刷题中知识点角色（已确认：Q19 标签辅助）

- 刷题模块**不单独出知识点题**
- 每道练习题旁显示**关联知识点标签**
- 做错时标签高亮，帮助学生快速定位薄弱知识点
- 点击标签可跳转到知识点详情页

---

## 二十一、快速开始含知识点（已确认：Q20 含但低优先级）

- "快速开始"推荐列表**可包含知识点**补强任务
- 优先级：错题分析 > 模型训练 > 知识点补强
- 知识点任务仅在AI诊断发现明确缺口时才推荐

---

## 二十二、粗心消杀触发（已确认：Q21 推送+主动入口）

- **推送**：周末推送提醒"本周有X个粗心记录待消杀"
- **主动入口**：周复盘页设常驻入口，学生可随时进入
- 粗心消杀内容：本周所有标记为"粗心/计算错误"的题目重做

---

## 二十三、AI诊断轮数（已确认：Q22 最多5轮）

- 最大对话轮数：**5轮**（快检→追问→深挖→确认→收敛）
- 5轮后仍无法精准定位 → 输出最佳猜测并注明置信度
- 大部分情况2-3轮即可定位，5轮上限保证复杂案例精准度

---

## 二十四、模型Tab Level 3交互（已确认：Q23 跳到详情页锚点）

- 点击子问题类型（Level 3节点）→ 直接跳转到**模型详情页对应锚点**
- 不需要新开页面，在详情页内定位到该子问题类型的训练入口
- 减少层级，降低跳转成本

---

## 二十五、社区Tab（已确认：Q25 保持原设计）

- 保持三个Tab：我的需求 / 新功能加速 / 改版建议
- 格式不变（投票/建议类型），可**多一个标签分类**
- V1不增加学习交流等复杂功能

---

## 二十六、一级/二级结论（已确认：Q28 引入，作为知识点属性）

### 概念定义
| 类型 | 定义 | 学习要求 | 考试影响 |
|------|------|---------|---------|
| **一级结论** | 基础原理/定律/公式 | 必须理解，对应掌握度"能解释" | 忘了=整道题废了 |
| **二级结论** | 推导出的快捷公式/记忆规律 | 记住即可，闪卡"记得"就行 | 忘了=多花1分钟推导 |

### 产品体现
- 每个知识点/公式**标注属性**：`conclusion_level: 1 | 2`
- 一级结论：知识点学习流程中重点讲解"为什么"，掌握度要求达到"能解释"
- 二级结论：闪卡为主，记住公式形式即可，掌握度到"做对过"即满足
- 诊断时优先检查一级结论掌握情况

---

## 二十七、预测系统（已确认：Q26 C - 预测驱动个性化路径，V1粗粒度版）

### 核心定位
- 预测系统 = **产品收费核心**，是"凭什么值500-1000/月/科"的答案
- 不只是一个分数数字，而是**学习GPS导航仪**
- 告诉学生："你现在X分，要到Y分，需要攻克这些模型/知识点，按这个顺序学"

### V1实现方式（粗粒度）
- **题号→模型/知识点映射表**：基于近1-2年高考卷结构（结构会变，以最新为准）
- 10年真题保证模型/知识点覆盖完整性（覆盖基本不变）
- V1按**题型块预测**（选择题整体、大题第一题整体），不精确到每一分
- 后期通过真实考试数据校准，逐步精细化

### 预测算法（V1）
> ⚠️ 已被Section五十二替代（Q72重写，完整数据来源追溯版本）。以下为旧版保留参考。
> 新版变更：level_to_prob适配新L0-L5含义，新增error_subtype微调(±5%)，新增未诊断错题折扣，模型/知识点概率分开设置。
> 详见 **Section 五十二**。

### 数据来源
- 学生在APP内的所有学习行为（闪卡、训练、检测）
- **每日上传**学校作业/练习的对错记录（见Q30讨论）
- 高考Tab上传的模考/真题卷成绩

---

## 二十八、分数预测展示方式（已确认：Q29 A+C + Q36 B）

### 预测中心（独立页面，主页入口进入）
- 主页卡片入口"查看我的分数预测 →"
- **只展示预测中心独有的内容**：
  - 预测总分（大数字）
  - 分数趋势图（近期变化曲线）
  - 学习路径推荐："从X分到Y分，优先攻克这3个模型/知识点"
- **不做题号级拆分**（题号视角在高考Tab，不重复）

### 高考Tab叠加预测数据（Q36 B）
- 高考Tab的每个**题号聚合页**新增一行："预测得分：X/Y分"
- 结合已有数据（正确率、薄弱模型）形成完整视图
- 学生在高考Tab自然看到："第3题，预测3/6分，薄弱：XXX模型"
- **不需要跳到别的页面，信息就在该在的地方**

### 关键节点触发
- 完成一轮模型训练后："恭喜！预测分数+3分"
- 做完一套卷子后：更新预测
- 周复盘时：展示本周预测变化趋势

> 原则：**每个页面只做自己该做的，不重复。** 预测中心=总分+趋势+路径，高考Tab=题号级细节+预测叠加。

---

## 二十九、后端标签/状态追踪体系（已确认：Q30）

### 每个知识点/模型的标签字段（完整集）
```
current_level: 0-5        // 当前掌握度
peak_level: 0-5            // 历史最高掌握度
last_active: timestamp     // 最后一次交互时间
error_count: int           // 累计错误次数
correct_count: int         // 累计正确次数
recent_results: [bool; 4]  // 最近4次对错记录（用于稳定性判定）
last_error_subtype: enum   // 最近一次错误子类，枚举值如下：
    // 模型类：identify_wrong | decide_wrong | step_wrong | subject_wrong | substitution_wrong
    // 粗心类：calc_error | symbol_error | reading_error | copy_error
    // 知识点类：concept_gap
conclusion_level: 1|2      // 仅知识点：一级/二级结论（用于路由分流）
reading_accuracy: float    // 仅学生全局：审题正确率（0-1，最近5次）
confusion_groups: [string] // 仅模型：所属易混组ID列表
// weak_step已废弃（Q63重构）：Level本身编码了瓶颈层，L1=Step1, L2=Step2, L3=Step3-5，不再需要额外字段
is_unstable: bool          // 仅模型：最近4次中既有对又有错时为true
next_retest_date: timestamp // 仅模型：L4后的下次延时复测日期（Q66）
    // ⚠️ 知识点不设is_unstable（知识点靠"解释"验证，不存在"做对做错交替"的场景）
    // 预测算法中，知识点的is_unstable视为false
```

### AI决策逻辑（纯标签推导）
- "从没学过" = `peak_level == 0`
- "学过但退步了" = `peak_level > 0 && current_level < peak_level`
- "很久没碰了" = `last_active > 14天前`
- "可能遗忘" = `last_active > 28天前`
- "稳定掌握" = `current_level == 5 && last_active < 14天`

### 每日上传机制（已确认：A 极简上传）
- 学生拍照上传当天所有题目 → 只标对/错
- 系统通过题库匹配关联到模型/知识点 → 更新标签
- 学生耗时：约3分钟/天
- **同时承担"发现问题"和"保护遗忘"双重功能**

### 每日上传后的处理算法
```
对上传的每道题：
1. 大模型识别 → 关联到 model_id + kp_ids[]（成本~0.1元/题）
2. 如果标"对"：
   ├── model.last_active = now
   ├── model.correct_count += 1
   ├── model.recent_results.push(true)
   ├── 对每个 kp_id: kp.last_active = now
   └── **不触发升级，不改current_level**（上传≠训练验证，不能凭此升级）
       如果model.peak_level==0 → peak_level=1（标记为"接触过"）
3. 如果标"错"（Q63重构：不再盲降，等诊断定位层次）：
   ├── model.last_active = now
   ├── model.error_count += 1
   ├── model.recent_results.push(false)
   ├── current_level **暂不降级**（仅凭"标错"无法确定错在哪一层）
   ├── 标记该题为"待诊断"(diagnosis_status=pending) → 进入主页推荐列表（高优先级）
   ├── 对每个 kp_id: kp.last_active = now
   └── AI诊断完成后：根据诊断出的错误层次精确降级
       ├── 诊断=识别层出错 → 降到L1
       ├── 诊断=列式层出错 → 降到L2
       ├── 诊断=执行层出错 → 降到L3
       └── 诊断=粗心 → 不降级（粗心不改level，走粗心消杀流程）
4. 更新 is_unstable 标记
```

> **关键区分（Q63更新）**：
> - 上传标"对"：只更新last_active，不升level（上传≠验证）
> - 上传标"错"：**不立即降级**，标记待诊断，等AI诊断定位到具体层后再精确降级
> - 训练中做错：系统知道在哪个Step失败，**可以立即精确降级**到对应层
> - 为什么改了：旧版"标错→一律降到L1"是盲降，新版Level编码了具体瓶颈层，盲降会丢失信息

### 标签更新算法（每次交互后执行）
```
触发事件 → 更新哪些标签：

⚠️ 关键区分：上传标"对"和训练做"对"不同！
- 上传标"对"：只更新last_active，不改level（上传不等于验证）
- 训练做"对"：可能触发升级（经过了系统验证流程）

1. 训练中做对（知识点检测对 / 模型Step 5对 / 模型Step 6对）：
   ├── last_active = now
   ├── correct_count += 1
   ├── recent_results.push(true)，保持长度4
   ├── current_level升级判定（Q63重构：按层升级）：
   │   ├── 知识点（每层对应一个验证关卡）：
   │   │   ├── recall测试通过（能回忆公式/概念）→ 如果当前L1 → 升到L2
   │   │   ├── 解释测试通过（能说清为什么）→ 如果当前≤L2 → 升到L3
   │   │   ├── Step 4概念检测对（能正确使用）→ 如果当前≤L3 → 升到L4
   │   │   └── 多次正确(间隔≥24h, ≥2次) → 升到L5
   │   └── 模型（每Step对应一层瓶颈突破）：
   │       ├── Step 1通过（识别正确）→ 如果当前L1 → 可升到L2（或直接跳到L4如果后续也通过）
   │       ├── Step 2通过（公式选对）→ 如果当前≤L2 → 可升到L3（或跳到L4）
   │       ├── Step 5回归对（全流程通过）→ 升到L4
   │       └── Step 6变式对 + 延时复测通过(间隔≥24h) → 升到L5
   │   ⚠️ 注意：模型可以跨级升——L1直接练到Step 5全通过 → 直接到L4，不用经过L2/L3
   └── peak_level = max(peak_level, current_level)

2a. 训练中做错（Q63重构：精确降级到出错的层）：
   ├── last_active = now
   ├── error_count += 1
   ├── recent_results.push(false)，保持长度4
   ├── current_level精确降级（下限为L1，不降到L0）：
   │   ├── 知识点（根据在哪步失败）：
   │   │   ├── recall失败(记不住) → 降到L1
   │   │   ├── 解释失败(理解不深) → 降到L2
   │   │   ├── 检测做错(使用出错) → 降到L3
   │   │   └── L5解释错 → L4；L0/L1/L2/L3不降
   │   └── 模型（根据在哪个Step失败）：
   │       ├── Step 1失败(识别错) → 降到L1
   │       ├── Step 2失败(公式选错) → 降到L2
   │       ├── Step 3-5失败(执行错) → 降到L3
   │       └── L5做错 → L4；L0/L1/L2/L3不降
   └── is_unstable = (recent_results.count(true) >= 1 && recent_results.count(false) >= 1)
       即4次中既有对又有错 → 不稳定

2b. 上传标"对"（不变）：
   ├── last_active = now
   ├── correct_count += 1
   ├── recent_results.push(true)
   ├── 如果peak_level==0 → peak_level=1（标记为"接触过"）
   └── current_level不变

2c. 上传标"错"（Q63重构：不再盲降）：
   ├── last_active = now
   ├── error_count += 1
   ├── recent_results.push(false)
   ├── current_level **暂不降级**（不知道错在哪一层，等诊断后精确降）
   ├── diagnosis_status = pending
   └── AI诊断完成后按2a规则精确降级

3. 快检结果：
   ├── 识别正确 → last_active = now（不改level）
   └── 识别错误 → 降到L1（快检测的就是建模层/识别能力）

4. 审题训练结果：
   └── reading_accuracy = 最近5次审题训练的正确率

5. AI诊断完成（Q63重构+Q65C：增加四层定位输出）：
   ├── last_error_subtype = 本次诊断结果子类
   ├── 根据四层诊断结果更新current_level：
   │   ├── 识别层出错 → current_level = 1
   │   ├── 列式层出错 → current_level = 2
   │   ├── 执行层出错 → current_level = 3
   │   └── 粗心 → current_level不变（走粗心消杀）
   └── diagnosis_status = completed
```

### 遗忘保护策略（乐观为主）
| 时间没碰 | 系统行为 | 是否降级 |
|---------|---------|---------|
| 0-14天 | 无动作，乐观信任 | ❌ 不降级 |
| 14天（2周大周期） | 标注"建议复习"，推荐列表中插入该模型/知识点的快检 | ❌ 不降级 |
| 28天（4周） | 标注"可能遗忘"，更积极推送复习 | ❌ 仍不降级 |
| **做错了** | 根据错误实际降级 | ✅ 降级 |

> 核心原则：**只有做错才降级，时间不降级。** 乐观假设学生记得，通过推荐+每日上传自然覆盖。

---

## 三十、统一上传体系 + 题目归属（已确认：Q31+Q33）

### 主页"+"按钮（统一上传入口）
点击"+"后展开3个选项：

| 选项 | 说明 | 处理流程 |
|------|------|---------|
| **上传作业** | 拍照上传今日作业 | 拍照→识别题目列表→逐题标对/错→系统匹配模型/知识点→更新掌握度 |
| **极简上传** | 最近做过的练习题快速记录 | 同上流程，标签为"练习" |
| **上传考试卷子** | 模考/真题卷 | 路由到高考Tab上传流程→按题号切分归档 |

### 题目识别与匹配（已确认：Q34 大模型打标签）
- 拍照后由**大模型识别题目并关联模型/知识点**
- 成本：~0.1元/次调用
- 已解决，无需额外设计

### 上传UX流程（已确认：Q33 A 拍照+手动标）
1. 选择上传类型（作业/练习/卷子）
2. 拍照（支持多页）
3. 系统展示识别出的题目列表
4. 学生逐题标"对/错"（识别不了的可跳过）
5. 完成 → 系统更新掌握度 + 存入历史

> 作业上传和极简上传本质是**同一个流程**，只是标签不同。UI复用。

### 统一上传历史
- 入口：主页"最近上传 →" 或 "我的"页面
- 按时间倒序展示所有上传记录
- 可筛选：按类型（作业/练习/卷子）、按日期、按对错
- **错题筛选 = 智能错题本**：筛选"错题" → 按价值排序（模型不会 > 知识点缺口 > 粗心）
- 每条记录显示：归属模型标签 + 知识点标签 + 闭环状态（已诊断/未诊断）
- 点击错题可直接进入AI诊断流程

### 题目归属规则
| 维度 | 关系 | 说明 |
|------|------|------|
| **模型（主归属）** | 1题→1主模型 | 题目在模型详情页可见（对的+错的） |
| **知识点（标签）** | 1题→N知识点标签 | 知识点页不直接放题，通过关联模型间接触达 |
| **高考题号（来源）** | 1题→1题号 | 在高考卷子Tab按题号聚合 |
| **上传历史（时间线）** | 1题→1上传批次 | 在统一历史页按时间查看 |

---

## 三十一、周复盘页（已确认方向：Q32 C，需保证质量）

### 目标
- 六步闭环的"复盘升级"环节
- **教练最集中的体现**：不只是告诉你"这周怎么样"，而是"下周你该怎么办"

### 质量原则
> **推荐的不准宁可不推荐。能做到80分的东西才考虑做。**

### V1设计（保守版，确保80分质量）
| 区域 | 内容 | 质量保证方式 |
|------|------|------------|
| **本周数据** | 闭环数、预测分数变化、掌握度变化 | 纯数据统计，100%准确 |
| **Top 3 优先级** | AI分析："你最应该优先攻克的3个模型/知识点" | 只基于高置信度数据（本周做错≥2次 or 关联题号分值高）|
| **策略建议** | AI一段话解释为什么推荐这3个 | 必须引用具体数据（"你本周在XXX模型错了3次"） |
| **下周方向** | "建议下周重点：XXX" | 只给方向，不排每日计划 |

### 不做的（V1质量不达标）
- ❌ 不做每日详细计划（需要知道学生每天可用时间，V1数据不足）
- ❌ 数据不足时不硬推（显示"继续学习，数据积累中"）
- ❌ 不做模糊推荐（每条建议必须有数据支撑）

### V2升级路径（数据足够后）
- 加入每日计划自动排入推荐
- 加入时间预估（"这个模型预计需要2小时攻克"）
- 加入同水平学生对比数据

### AI提示词拼接模板（周复盘）
```
学生本周学习数据：
- 完成训练：{completed_trainings}
- 错题诊断：{diagnosed_errors}
- 掌握度变化：{mastery_changes}
- 预测分数变化：{prediction_change}

分数影响映射表：{score_impact_map}（哪些模型/知识点对分数影响最大）

规则：
1. 只推荐有明确数据支撑的优先级（错≥2次 或 分值影响前10%）
2. 数据不足的领域说"数据不足"，不猜测
3. 每条建议必须引用具体数据
4. 最多推荐3个优先级

请生成：本周总结 + Top 3优先级 + 下周方向建议
```

---

## 三十二、模型族设计（已确认：Q38 不做结构化）

- **不引入** model_family 标签或父子层级
- 模型之间的表面联系仅作为记忆辅助，不影响系统结构
- 每个模型保持独立节点，AI讲解时可口头提及相关模型（"这和XX模型类似"）即可

---

## 三十三、过程拆分与主语确定（已确认：Q39）

### 核心理念
- 每道物理题 = 若干个运动过程，每个过程有确定的主语
- **即使同为匀加速运动，加速度不同 = 两个不同过程**
- 每个公式必须对应：确定的过程 + 确定的主语

### 对模型6步训练的影响
- **Step 1（识别）** 升级为：**过程拆分 + 模型识别**
  - 先引导学生把题目拆成几个过程（几段运动/几个阶段）
  - 每个过程确定主语（对谁分析？）
  - 然后为每个过程选择模型
- **Step 2（决策）** 承接：在已确定的过程+主语下选择公式
- AI提示词模板增加："这道题有几个过程？每个过程的研究对象是谁？"

### "主语错"诊断标准
- 公式正确，但列错了对象 → 主语错
- 公式正确，但应用到了错误的过程段 → 也归主语错
- 与Q37的"主语错"子类对应

---

## 三十四、"不敢写"检测与穷举引导（已确认：Q40 AB）

### 双管齐下
1. **穷举教学**：Step 1-2中教学生"列出所有可能的公式/模型，逐个排除"的通用策略
2. **行为检测**：如果学生在Step 5（回归题）长时间不输入（>90秒），AI主动提示

### AI行为检测触发
- 触发条件：Step 5填空阶段，某一步空白超过90秒
- 触发动作：AI发送鼓励 + 方法提示
  - "不确定也没关系，先把你觉得可能用到的公式都列出来"
  - "想想这个过程的研究对象是谁？对它能列什么式子？"
- 不降级，不跳步，只是鼓励 + 给方法

---

## 三十五、热身机制（已确认：Q41 不做）

- **不引入**显式热身机制
- 如果学生做不出来，由**现有路由规则自动降级到合适步骤**
- 路由层已有逻辑：peak_level高但current_level低 → 从检测步开始 → 错了退回训练
- 这个机制本身就是隐式热身，无需额外设计

---

## 三十六、掌握度稳定性判定（已确认：Q42 B + Q46）

### 防假会机制
- 不额外加"解释环节"来验证真会
- **变式题（Step 6）本身就是防假会机制**：靠直觉做对的，换题型大概率暴露
- 暴露后自然回退掌握度等级

### 不稳定模型的深度诊断（已确认：Q46）
- **检测条件**：同一模型最近4次练习中，正确率在25%-75%之间（一次对一次错）
- **检测时机**：每次更新recent_results后自动检查
- **触发动作**：标记该模型为"不稳定"(is_unstable=true)，AI诊断从常规模式切换为**深度诊断模式**
  - 常规诊断：判断属于哪类错误（4大类）→ 最多5轮
  - 深度诊断：在子类内继续追问，找到更小的错误粒度 → 最多5轮但追问更深
    - 例：不是笼统的"步骤错"，而是"第2步到第3步的符号代换出错"
    - 例：不是笼统的"识别错"，而是"遇到斜面就默认用牛顿第二定律，忽略了能量方法"
- **对预测的影响**：不稳定模型预测时乘0.7折扣（见预测算法）
- **退出条件**：连续3次做对（recent_results最近3个都是true）→ is_unstable=false
- **目标**：通过更细粒度的诊断，找到导致波动的根本原因，而不仅仅是标记"不稳定"

### 深度诊断AI提示词模板
```
学生在{model_name}上表现不稳定（最近4次：{recent_results}）
最近错误子类记录：{last_error_subtypes}
本次做错的题：{question_summary}
学生解答过程（如有）：{student_answer}

这个学生不是"不会"，而是"时对时错"。请深入分析：
1. 先判断属于哪个大类（识别错/决策错/步骤错/主语错）
2. 在该大类内，追问到具体是"哪一步""哪个条件""哪个转换"出了问题
3. 对比之前的错误记录，看是否存在重复的微观错误模式
最大轮数：5轮。目标：找到一个具体的、可训练的微观错误点。
```

---

## 三十七、易混模型对比表（已确认：Q43）

### 触发机制
- 教研团队预设**易混组**（confusion groups），例如：
  - {动能定理, 能量守恒, 动量守恒}
  - {牛顿第二定律, 动量定理}
  - {库仑定律, 电场力公式}
- AI诊断为"识别错"或"决策错"时，检查学生选错的模型/公式和正确答案是否属于同一易混组
- **属于同一易混组** → 自动展示预设的对比表
- **不属于** → 走常规训练流程

### 对比表结构（教研预设，非AI生成）
| 列 | 内容 |
|----|------|
| 模型名称 | 动能定理 / 能量守恒 / 动量守恒 |
| 适用条件 | 合外力做功 / 系统内力+外力 / 系统合外力为零 |
| 关键区别 | 单物体vs系统 / 有无非保守力 / 有无外力 |
| 典型信号词 | "求速度变化" / "求系统末态" / "碰撞、爆炸" |

### 闪卡联动
- 对比表展示后，自动生成对应的**辨析卡**加入闪卡系统
- 辨析卡内容 = 对比表的简化版，进入间隔复习

---

## 三十八、审题训练模块（已确认：Q44 独立模块 + Q47 触发逻辑）

### 设计理念
- 过程拆分 + 主语确定 = 所有模型训练的**前置基础能力**
- 选对了过程和主语，才能选对公式
- 需要独立训练，不仅仅是Step 1的一部分

### 训练形式：过程重述
给出一道题目，学生完成以下结构化重述（不涉及公式选择）：

| 步骤 | 学生操作 | AI判定 |
|------|---------|--------|
| 1. 有几个过程？ | 学生回答数量 + 每个过程的起止点 | 对比标准答案 |
| 2. 每个过程的研究对象？ | 学生回答主语 | 判定是否正确 |
| 3. 每个过程的关键特征？ | "匀加速/匀减速/自由落体/圆周..." | 判定分类是否正确 |
| 4. 过程之间的转折点？ | "速度为零时/脱离接触时/摩擦力方向改变时..." | 判定是否识别关键转折 |

### 触发条件（已确认：Q47）

按学生进入模型训练时的状态，决定是否插入审题训练：

```
学生进入模型训练
├── 状态A（完全新学，peak=0）
│   → 正常走6步，Step 1自然包含过程拆分教学
│   → ❌ 不插入审题训练
│
├── 状态B（做错题被AI诊断分流）
│   ├── 诊断结果 = "主语错" 或 "识别错"
│   │   └── 检查审题正确率标签
│   │       ├── 审题正确率 < 60% → ✅ 先插入1道审题训练，再进模型Step 1
│   │       └── 审题正确率 ≥ 60% → ❌ 直接进Step 1（内含过程拆分引导）
│   └── 诊断结果 = "决策错" 或 "步骤错"
│       → ❌ 不插入，直接进对应Step
│
├── 状态C（久未练习，last_active > 14天）
│   → 先走快检（见Section四十三），快检结果决定后续
│   → ❌ 审题训练不在此触发
│
└── 状态D（主动复习，自己点进来）
    → 正常走路由规则
    → ❌ 不插入审题训练
```

核心原则：**审题训练只在"做错题分流 + 诊断指向审题类问题 + 历史审题正确率差"时触发。精准触发，不浪费时间。**

### 题库要求
- 教研预设，每题标注标准答案（几个过程、每个过程主语、转折点）
- 难度分级：单过程单主语 → 多过程单主语 → 多过程多主语 → 含隐蔽转折点
- 按模型关联，例如"牛顿第二定律"关联的审题训练题

### 掌握度与标签
- 不设独立掌握度等级
- 新增标签字段：`reading_accuracy: float`（审题正确率，0-1）
- 每次审题训练后更新：`reading_accuracy = 最近5次审题训练正确率`
- 影响模型训练时Step 1的AI引导深度：
  - 审题正确率 ≥ 60% → Step 1快速带过过程拆分
  - 审题正确率 < 60% → Step 1重点引导过程拆分
- 成本：0（审题训练纯规则判定，不调大模型；只需匹配预设标准答案）

---

## 三十九、粗心细分记录（已确认：Q45 A）

### 粗心子类
| 子类 | 描述 | 示例 |
|------|------|------|
| 计算错 | 纯计算失误 | 3×4=11 |
| 符号错 | 正负号/下标/单位 | F₁写成F₂、漏负号 |
| 审题错 | 题目条件看错/漏看 | "光滑"没注意到 |
| 抄错 | 从上一步到下一步抄写出错 | 把v₀=3抄成v₀=5 |

### V1策略
- AI诊断为"粗心"时，尝试进一步分到子类（通过追问或分析错误位置）
- 仅**记录统计**，不做专项训练
- **周复盘中展示**："本周计算错误2次，符号错误3次——你的符号规范可能需要注意"
- V2根据数据决定是否为高频子类开发专项训练

---

## 四十、一级/二级结论学习路径（已确认：Q48）

### 核心区别
| 类型 | 学习目标 | 掌握标准 |
|------|---------|---------|
| 一级结论 | **理解**原理/推导过程 | 能解释为什么 |
| 二级结论 | **知道**从哪来 + **记住**什么时候能用 | 知道来源 + 记住使用条件 |

### 知识点5步流程的分路
**一级结论**：完整5步
```
Step 1 → Step 2(完整呈现) → Step 3(关键点解释确认) → Step 4(概念检测) → Step 5(闪卡)
```

**二级结论**：简化3步
```
Step 1 → Step 2(简要展示来源："这个公式由XX推导而来") → Step 4(使用条件检测："什么情况下能用这个？") → Step 5(闪卡)
```
- 跳过 Step 3（不要求深入解释推导，只要知道来源）
- Step 4检测重点从"理解"变为"记忆使用条件"
- 闪卡以**条件卡**为主（"什么时候用？"）

### 路由层实现
- 知识点标签增加属性：`conclusion_level: 1 | 2`
- 路由规则读取此标签，决定走完整流程还是简化流程

---

## 四十一、跨模型错误模式识别（已确认：Q49 A 现有机制）

- V1不做自动跨模型分析
- **周复盘** + **高考卷子视角** 天然承担"找多道题宏观规律"的功能
  - 周复盘：统计"本周各类错误频次"，可见跨模型共性
  - 高考视角：按题号/题型聚合，可见某类题型反复丢分的模式
- V2数据积累后，可升级为自动标签+推荐

---

## 四十二、AI人格设定（已确认：Q51 B 按模块微调）

### 全局基础人格
- **耐心 + 简洁 + 不放水**：所有模块共享的基底

### 模块微调
| 模块 | 语气调整 | 示例 |
|------|---------|------|
| 诊断阶段 | 更温和，不评判 | "没关系，我们来看看哪里卡住了" |
| 训练阶段 | 更严格，不放水 | "这一步不对，再想想对谁列的式子？" |
| 复盘阶段 | 更鼓励，给信心 | "这周你在XX模型上有明显进步" |

### prompt实现
- 全局prompt开头：统一角色设定（100字以内）
- 每个模块prompt前缀：追加1-2句语气指令
- 成本：0（只是prompt文本差异，不增加调用次数）

---

## 四十三、快检题设计（已确认：Q50 + Q5合并解决）

### 快检的本质
快检 = **用最少时间判断学生对某模型还记得多少**。不是训练，是**路由入口的快速分诊**。

### 触发条件
```
触发快检的前提：
├── peak_level > 0（学过这个模型）
├── last_active > 14天（超过两周没碰）
└── 学生以某种方式接触到该模型（非做错题场景）
```

### 触发场景
| 场景 | 描述 | 是否走快检 |
|------|------|-----------|
| 周复盘推荐 | "你的XX模型14天没练了" → 学生点击 | ✅ 触发快检 |
| 学生主动点进 | 在全局Tab点进该模型 | ✅ 系统检测last_active > 14天 → 弹快检 |
| 做错题分流 | 上传作业/考试，错题涉及该模型 | ❌ 已有错误信息，直接走AI诊断 |
| 做对了该模型的题 | 上传时标"对" | ❌ 不需要快检，直接更新last_active |
| 闪卡复习涉及 | 闪卡系统独立 | ❌ 不触发模型快检 |

关键区分：**做错了 → 走诊断（有错误信息可分析）；没有新对错信息 → 走快检（需要主动探测）**

### 快检形式
- **测识别能力**：给1道题，只问"这道题用什么模型/方法？"
- 不需要解题，不需要计算
- 1题，约30秒
- 成本：0（纯规则判定匹配预设答案，不调大模型）

### 快检题库
- 每个模型预设2-3道快检题（教研制作）
- 题目要求：能一眼看出需要用某模型的**典型题**，不需要复杂条件
- 轮换使用，避免学生记住答案
- 标注标准答案：正确模型名称

### 快检后路由（Q63适配）
```
快检结果
├── 识别正确 → 学生还记得这个模型（建模层OK）
│   └── current_level维持 → 进入Step 5（回归验证）
│       ├── Step 5对 → Step 6（变式） → 进入延时复测队列
│       └── Step 5错 → AI诊断定位出错的层 → 降到对应Level → 进对应Step
└── 识别错误 → 建模层出问题
    └── current_level降到L1（建模卡住）→ 进入Step 1
```

### 与遗忘保护策略的关系
| 时间段 | 系统行为 | 快检角色 |
|--------|---------|---------|
| 0-14天 | 无动作，乐观信任 | 不触发 |
| 14天+ | 标注"建议复习"，推荐列表插入 | 学生点击推荐 → 触发快检 |
| 28天+ | 更积极推送 | 同上，但推送更频繁 |

---

## 四十四、完整页面清单 + 导航地图

### 一级页面（底部Tab直达）

| # | 页面名 | 入口 | 核心元素 | 交互 |
|---|--------|------|---------|------|
| P1 | **主页** | 底部Tab"主页" | "+"浮动按钮、推荐区(卡片列表)、快速开始按钮、预测中心入口卡片、今日数据卡片、上传历史入口 | 见下方详细 |
| P2 | **全局-知识点Tab** | 底部Tab"全局"→顶部子Tab"知识点" | 三级树形列表(章→节→知识点)，每个节点显示掌握度图标(L0灰/L1红/L2橙/L3黄/L4蓝/L5绿) | 点击L3节点→P7知识点详情 |
| P3 | **全局-模型Tab** | 底部Tab"全局"→顶部子Tab"模型/方法" | 三级树形列表(章→模型→子问题)，跨章模型有"跨:XX"标签 | 点击L2模型→P8模型详情；点击L3→P8锚定到该子类 |
| P4 | **全局-高考Tab** | 底部Tab"全局"→顶部子Tab"高考卷子" | 题型分组→题号列表(每个显示正确率+做题数)→具体题目列表；顶部有上传按钮 | 点击题号→P9题号聚合页；点击具体题→P10题目详情 |
| P5 | **记忆Tab** | 底部Tab"记忆" | 今日待复习卡片数、开始复习按钮、复习历史统计、卡片管理入口 | 点击"开始复习"→P11闪卡复习 |
| P6 | **社区Tab** | 底部Tab"社区" | 三个子Tab：我的需求/新功能加速/改版建议，投票列表 | 按原设计 |
| P6b | **我的Tab** | 底部Tab"我的" | 个人信息、上传历史入口、设置 | 点击上传历史→P15 |

### 二级页面（从一级页面跳转）

| # | 页面名 | 入口 | 核心元素 | 交互 |
|---|--------|------|---------|------|
| P7 | **知识点详情页** | P2点击知识点 | 掌握度仪表盘(当前Level+进度)、一级/二级结论标签、关联模型列表(点击跳P8)、[开始学习]按钮、概念检测记录 | [开始学习]→P12知识点学习流 |
| P8 | **模型详情页** | P3点击模型 | 掌握度仪表盘、前置知识点区域(掌握度+跳P7链接)、相关题目列表、is_unstable标记、[开始训练]按钮、[快检]（如last_active>14天） | [开始训练]→P13模型训练流 |
| P9 | **题号聚合页** | P4点击题号 | 累计做题数、正确率、高频考点标签、薄弱模型标签、预测得分"X/Y分"、该题号下所有题目列表 | 点击题目→P10；点击模型标签→P8 |
| P10 | **题目详情页** | P9/P15点击具体题 | 题目图片、对错状态、归属模型标签、知识点标签、诊断状态(待诊断/已诊断/已完成闭环) | [进入诊断]→P14 AI诊断 |
| P11 | **闪卡复习** | P5"开始复习" | 卡片正面→点击翻转→卡片背面→底部三按钮"忘了/记得/简单"→下一张；顶部进度条(当前/总数) | 完成→P5返回+统计 |
| P12 | **知识点学习流** | P7[开始学习] | 对话界面(AI气泡+学生输入)，步骤进度条(Step 1→5)，预设内容穿插展示，检测题选择题UI | 完成→P7更新掌握度 |
| P13 | **模型训练流** | P8[开始训练] | 对话界面+结构化交互，步骤进度条(Step 1→6)，Step 1选项列表，Step 2公式排除列表，Step 5分步填空表单 | 完成→P8更新掌握度 |
| P14 | **AI诊断对话** | P10[进入诊断] | 对话界面(最多5轮)，AI提问气泡+学生回答输入框，诊断结果卡片(**三段式**：①问题定位→②可解决性→③目标分影响+X分) | 诊断完→跳转P12或P13 |
| P15 | **统一上传历史** | P1"最近上传"或P6b | 时间倒序列表，每条显示：日期+类型标签+题目预览+对错标记+诊断状态；顶部筛选栏(类型/日期/对错) | 点击错题→P10；筛选"错题"=智能错题本 |
| P16 | **预测中心** | P1预测卡片 | 预测总分(大数字)、趋势折线图(近4周)、学习路径推荐(Top3卡片，点击→P8/P7)；数据不足时显示"继续学习，数据积累中" | 点击推荐→跳转 |
| P17 | **周复盘页** | 推送/P1 | 本周数据统计卡片、Top 3优先级列表(每条有理由标签)、AI策略建议文本、下周方向建议、粗心消杀入口 | 点击优先级→P8/P7 |
| P18 | **审题训练** | P13前自动插入 | 题目展示→4步结构化表单(过程数→主语→特征→转折点)→提交→AI判定结果(对/错+标准答案) | 完成→返回P13继续 |
| P19 | **快检** | P8自动弹出(last_active>14天) | 弹窗：题目+问题"这道题用什么模型？"→选项列表(3-4个模型选择)→提交→结果(对/错) | 完成→路由到P13对应Step |

### 三级页面/弹窗

| # | 页面名 | 入口 | 核心元素 |
|---|--------|------|---------|
| M1 | **"+"上传菜单** | P1点击"+" | 底部弹出3个选项卡片：上传作业/极简上传/上传考试卷子，点击外部关闭 |
| M2 | **拍照上传流** | M1选择任一选项 | 相机→多页拍照→AI识别→题目列表(每题有对/错开关)→确认提交 |
| M3 | **易混对比表** | P13 Step2中自动弹出 | 弹窗：表格(模型名/适用条件/关键区别/信号词)→[我知道了]关闭→返回训练 |
| M4 | **"不敢写"提示** | P13 Step5超90秒 | 对话气泡形式：鼓励文本+方法提示，不打断流程 |
| M5 | **粗心消杀** | P17入口 | 题目列表→逐题重做(分步填空)→完成统计 |

### 注册/引导页面（首次使用，已确认Q52B+Q53B）

| # | 页面名 | 入口 | 核心元素 | 交互 |
|---|--------|------|---------|------|
| R1 | **注册-基础信息** | 首次打开APP | 地区选择(省/市下拉)、目标裸分输入(滑条+数字)、可选当前水平自述 | 完成→R2 |
| R2 | **注册-卷面策略** | R1完成 | 策略表(题号/满分/目标得分/态度🔴🟡⚪/说明)、关键话术、[开始诊断] | [开始诊断]→R3 |
| R3 | **注册-自适应诊断** | R2[开始诊断] | 对话界面(AI+简单题)、进度条、三维画像结果+目标关联话术 | 完成→P1主页 |

### 全局导航流程图
```
                        ┌──── P2 知识点Tab ─── P7 知识点详情 ─── P12 知识点学习流
                        │
P1 主页 ── P16 预测中心  ├──── P3 模型Tab ───── P8 模型详情 ──┬── P19 快检
    │                   │                                   └── P13 模型训练流 ── P18 审题训练
    ├── M1 上传菜单      ├──── P4 高考Tab ───── P9 聚合页 ──── P10 题目详情
    │   └── M2 拍照上传  │                                         │
    ├── P15 上传历史 ────┘                                     P14 AI诊断
    ├── P17 周复盘                                              │
    └── P5 记忆Tab ─── P11 闪卡复习                         ┌──┴──┐
                                                           P12   P13
                                                         (知识点) (模型)
```

### 页面间跳转触发条件汇总
| 从 | 到 | 触发条件 |
|----|----|---------| 
| P1 | P14 | 点击推荐区"待诊断错题"卡片 |
| P1 | P13 | 点击推荐区"模型训练"卡片 或 快速开始 |
| P1 | P12 | 点击推荐区"知识点补强"卡片 |
| P1 | P16 | 点击预测中心入口卡片 |
| P1 | P15 | 点击"最近上传→" |
| P1 | M1 | 点击"+"浮动按钮 |
| P8 | P19 | 进入模型详情时，系统检测last_active>14天，自动弹出 |
| P8 | P13 | 点击[开始训练]按钮 |
| P13 | P18 | 路由层判定需要审题训练时，自动插入 |
| P13 | M3 | Step 2中AI检测到易混组匹配，自动弹出 |
| P13 | M4 | Step 5中超90秒不输入，自动弹出 |
| P14 | P12 | 诊断结果=知识点缺口，点击[去学习] |
| P14 | P13 | 诊断结果=模型应用问题，点击[去训练] |
| P10 | P14 | 点击[进入诊断]（diagnosis_status=pending时可见） |
| P19 | P13 | 快检完成后，自动路由到对应Step |

### 通用交互规范
- **对话界面**（P12/P13/P14）：聊天气泡形式，AI在左学生在右，底部输入框+发送按钮
- **步骤进度条**（P12/P13）：顶部横向步骤条，当前步骤高亮，已完成打勾
- **掌握度图标**（全局通用）：L0灰色圆/L1红色/L2橙色/L3黄色/L4蓝色/L5绿色
- **对错标记**（M2/P15）：绿色勾=对，红色叉=错
- **筛选栏**（P15）：顶部横向标签（全部/作业/练习/卷子）+ 右侧筛选按钮（日期/对错）
- **卡片组件**（P1推荐区/P16路径推荐）：圆角卡片，标题+理由标签+右箭头
- **弹窗**（M1/M3/P19）：半透明遮罩+底部/中心弹出，点击遮罩或按钮关闭

---

## 四十五、AI提示词变量参考表

### 变量格式定义
所有AI提示词模板中的 `{variable_name}` 变量，按以下格式传入：

| 变量名 | 数据类型 | 来源 | 示例值 |
|--------|---------|------|--------|
| `question_summary` | string | 大模型识别结果的题目文本摘要 | "一个质量为m的物体在光滑斜面上..." |
| `related_knowledge_points` | string[] | 题目标签kp_ids对应的名称列表 | ["牛顿第二定律", "摩擦力"] |
| `related_models` | string[] | 题目标签model_id对应的名称列表 | ["斜面受力分析", "牛顿第二定律应用"] |
| `knowledge_mastery` | object | `{kp_name: current_level}` | {"牛顿第二定律": 4, "摩擦力": 2} |
| `model_mastery` | object | `{model_name: {current_level, peak_level, is_unstable}}` | {"斜面模型": {level:3, peak:4, unstable:true}} |
| `common_errors` | string[] | 该学生最近10次诊断的error_subtype列表 | ["subject_wrong", "decide_wrong", "subject_wrong"] |
| `conversation_history` | object[] | `[{role: "ai"|"student", content: string}]` | [{"role":"ai","content":"这道题你觉得该用什么方法？"}] |
| `mastery_status` | string | 当前掌握度状态描述 | "Level 2 - 列式卡住" 或 "Level 2 - 理解不深"（模型/知识点含义不同）|
| `preset_content_json` | object | 教研预设内容结构体 | {"definition":"...","formula":"...","conditions":"...","notes":"...","image_url":null,"quiz":[...]} |
| `candidate_models` | object[] | `[{name, description, is_correct}]` | [{"name":"动能定理","desc":"...","correct":false}, ...] |
| `candidate_formulas` | object[] | `[{formula, applicable_condition, is_correct}]` | 同上结构 |
| `standard_steps` | string[] | 标准解题步骤列表 | ["1. 确定研究对象", "2. 受力分析", "3. 列方程"] |
| `common_traps` | object[] | `[{description, wrong_answer, correct_answer}]` | [{"desc":"忘记摩擦力方向","wrong":"向上","correct":"沿斜面向下"}] |
| `fill_in_steps` | object[] | `[{step_num, prompt, expected_answer}]` | [{"step":1,"prompt":"研究对象是？","expected":"物体A"}] |
| `variant_question` | object | `{question_text, image_url?, expected_model, expected_steps}` | 题目结构体 |
| `personality_prefix_training` | string | 预设文本，从Section四十二读取 | "你是一个耐心但严格的学习教练。训练阶段..." |
| `score_impact_map` | object | `{model_name: affected_question_numbers[]}` | {"动能定理": ["选择5","大题1"]} |
| `reading_accuracy` | float | 学生全局标签 | 0.45 |
| `recent_results` | bool[] | 模型标签 | [true, false, true, false] |
| `student_answer` | string | 学生在训练中的输入文本 | "用动能定理对整体..." |

---

## 审计补充：完整数据模型一览

### 题目(Question)数据结构
```
question_id: string
source: enum (homework | practice | exam)
upload_batch_id: string      // 属于哪次上传
image_url: string            // 拍照图片
is_correct: bool             // 学生标注的对错
primary_model_id: string     // 主归属模型（大模型打标签）
related_kp_ids: [string]     // 关联知识点列表
exam_question_number: int?   // 高考题号（仅考试卷子有）
diagnosis_status: enum (pending | diagnosed | skipped)
diagnosis_result: {
  error_type: enum (careless | kp_gap | model_gap | reading_error)
  error_subtype: string?     // 细分子类
  confidence: float
}
created_at: timestamp
```

### 学生(Student)全局标签
```
region_id: string             // 省份/城市，决定卷面结构模板
target_score: int             // 目标裸分
exam_strategy: object         // 卷面策略表（注册时生成，目标分变更时重算）
formula_memory_rate: float    // 公式记忆度（0-1，注册诊断初始化）
model_identify_rate: float    // 模型识别力（0-1，注册诊断初始化）
calculation_accuracy: float   // 计算准确度（0-1，注册诊断初始化，日常更新）
reading_accuracy: float       // 审题正确率（0-1）
total_closures_today: int     // 今日闭环数
total_closures_week: int      // 本周闭环数
predicted_score: float        // 最新预测总分
last_prediction_time: timestamp
```

### 易混组(ConfusionGroup)数据结构
```
group_id: string
model_ids: [string]          // 组内模型ID列表
comparison_table: {          // 教研预设对比表
  headers: [string]
  rows: [[string]]
}
```

---

## 四十六、地区卷面结构 + 分数策略模板（已确认Q57B：人工设计）

### 设计原则
- 每个城市的诊断路径和分数策略**必须由教研老师人工设计**（不能自动生成）
- 原因：题型和分数映射每年有~30%变化，需要准确性；其他学科很难套用同一套规则
- 每个"城市+科目+分数档"=一份完整的得分模板+诊断路径
- V1先做天津物理作为模板示例，其他城市教研参照填充

### 模板层级结构
```
地区 → 科目 → 分数档 → 得分模板 + 诊断路径

示例：
天津 → 物理 → 70分档（含卷面策略+诊断顺序+UI文案）
天津 → 物理 → 80分档
天津 → 物理 → 90分档
天津 → 物理 → 100分档（注：100分也有不需要完全掌握的题）
```

### 完整模板数据结构
```
score_strategy_template:
  region_id: string            // "tianjin"
  subject: string              // "physics"
  target_score: int            // 70
  total_score: int             // 100

  # ====== 一、卷面结构定义 ======
  exam_structure: [
    {
      section_name: string     // "选择题" / "实验题" / "计算题" / "选做题"
      questions: [
        {
          question_number: int | string  // 题号，如 1 或 "15(1)"
          max_score: int
          difficulty: enum     // easy / medium / hard / extreme
          typical_models: [string]       // 高频模型ID列表
          typical_kps: [string]          // 高频知识点ID列表
        }
      ]
    }
  ]

  # ====== 二、分数档卷面策略 ======
  question_strategies: [
    {
      question_range: string   // "选择1-10（单选）"
      max_score: int           // 30
      target_score: int        // 27
      attitude: enum           // must / try / skip
      note: string             // "最多错1个"
      display_text: string     // 给学生看的话："这些你绝对能做到"
    }
  ]

  # ====== 三、诊断路径（教研人工排序）======
  diagnosis_path: [
    {
      tier: int                // 1=必测（大题核心） 2=必测（选择高频） 3=可选跳过
      model_id: string
      score_impact: string     // "12-18分"
      test_question_id: string // 诊断用预设题ID
      reason: string           // "大题第一/二题核心"
      skippable: bool          // tier 3允许跳过
    }
  ]
  # 天津物理示例：
  # tier 1: 板块运动、碰撞、电磁复合场、单棒切割、磁流体发电机
  # tier 2: 平抛运动、圆周运动、斜面下滑
  # tier 3(可选): 天体运动、光学、原子物理、热力学

  # ====== 四、分数档差异说明 ======
  key_message: string          // "70分=选择题最多错2个+大题前两道拿满，你做得到"
  vs_lower: string             // "比60分多要求：大题第一题全拿+选择多对2道"
  vs_higher: string            // "比80分允许放弃：大题第三题、多选最后一道"
```

### 100分档的特殊设计
- 即使目标100分，某些题也不需要"完全掌握"
- 例：天津卷最后一道大题（创新题）常规年份拿12/18分即可
- 100分模板的note = "所有题🔴，但最后大题只需拿12/18"
- 目的：消除学生"100分=全部都会"的焦虑

### UI呈现要求（像电影一样清晰）
- 注册完成后的策略展示是**核心转化页面**（让家长和学生都能看懂）
- 视觉设计目标：
  - 卷面全景图：每个题号是一个方块，颜色=态度（红绿黄）
  - 目标分数大数字 + "你需要做到" vs "你现在的位置"
  - 模型掌握地图：与策略表联动，哪些模型关系到🔴必须题一目了然
  - 动画过渡：从"全景"→"聚焦你的薄弱点"→"你的路径"
- 家长也能截图理解："我孩子的目标是XX分，需要攻克这3个模型"

### 教研填充规范
- 每个城市至少做4个分数档（60/70/80/90，需要可加100）
- 每个分数档包含：卷面策略表 + 诊断路径 + 关键差异说明 + UI文案
- 每年高考后教研团队更新模板（~30%调整）
- diagnosis_path中tier 1/2/3由教研根据分值影响手动分配

---

## 四十七、上传考试卷子交互流程（已确认Q56：完善细节）

### 完整交互步骤

**Step 1：选择上传类型**
```
学生点击"+" → 选择"上传考试卷子"
→ 弹窗："这张卷子按标准高考结构出的吗？"
  ├── [是/大致是] → 走情况A（快速映射流程）
  └── [不是/不确定] → 走情况B（AI识别流程）
```

**Step 2：拍照（两种情况共用）**
```
相机界面：
- 支持连续拍多页（翻页拍照）
- 底部显示已拍页数"已拍 3/? 页"
- [完成拍照] 按钮
- 拍完后可预览、删除、补拍
```

**Step 3A：快速映射流程（标准结构卷）**
```
1. 系统加载学生地区的卷面结构模板
2. 展示题号列表（自动生成，无需AI识别）：
   | 题号 | 满分 | 态度标签 | 对/错/半对 |
   |------|------|---------|-----------|
   | 选择1 | 3分 | 🔴 | [对] [错] |
   | 选择2 | 3分 | 🔴 | [对] [错] |
   | ...  |     |        |           |
   | 大题1 | 12分 | 🔴 | [对] [错] [半对→输入实得分] |
   | 大题2 | 14分 | 🟡 | [对] [错] [半对→输入实得分] |
3. 学生逐题标注对错（大题支持"半对"+输入实得分）
4. 系统自动计算总分 + 与目标分对比
5. 展示结果摘要：
   - "本次考试XX分，距离目标还差Y分"
   - "🔴必须题扣了Z分，建议优先处理"
   - 错题自动归档到高考Tab对应题号

成本：0元（纯规则映射，不需要AI）
```

**Step 3B：AI识别流程（非标准结构卷）**
```
1. AI处理拍照图片（~0.2-0.3元，因为整张卷子图片量大）
   → 输出：[{题号猜测, 题目摘要, primary_model_id, related_kp_ids}]
2. 系统展示AI识别结果，学生可修正题号
3. 学生逐题标对/错/半对
4. 每道题的model_id/kp_ids已由AI打标
5. 通过model_id反向映射到地区模板的题号位置（尽力而为）
   → 如果映射成功：显示态度标签
   → 如果映射失败：不显示态度标签，仅做模型/知识点关联

成本：~0.2-0.3元（1次AI调用识别整张卷）
```

**Step 4：结果展示与后续（共用）**
```
结果页展示：
├── 总分 + 目标分对比（大数字）
├── 🔴必须题的得分情况（重点关注）
├── 错题列表（按态度优先级排序：🔴 > 🟡 > ⚪）
├── [进入诊断] 按钮（对每道错题）
└── "这次考试暴露的主要问题是XX模型" （AI一句话总结，~0.1元）

错题自动：
├── 归入高考Tab对应题号
├── 标记为 diagnosis_status = pending
├── 进入主页推荐候选池
└── 更新掌握度标签（错题降级逻辑，见Section二十九）
```

### "半对"处理规则
```
大题标"半对"时：
├── 学生输入实得分（例：12分满分得6分）
├── 得分率 = 实得分 / 满分 = 0.5
├── 标签更新：
│   ├── 得分率 ≥ 0.7 → 不降级（大部分对了，可能只是计算扣分）
│   ├── 得分率 0.3-0.7 → 降1级（部分会但有明显问题）
│   └── 得分率 < 0.3 → 等同"错"（基本不会）
├── diagnosis_status = pending（建议诊断，但不强制）
└── 记录实得分用于预测算法校准
```

---

## 四十八、状态可视化设计（已确认Q68C：双层展示）

### 设计原则
> 家长关心"高考哪些题能拿分"，学生关心"我卡在哪"。用两层展示分别满足。

### 第一层：卷面热力图（概览层 → 支撑卖点B）
```
展示位置：主页核心卡片 + 高考Tab顶部

展示内容：
以高考卷面为底（选择题1-8 / 实验题 / 大题1-3 / 选做题），
每道题用颜色标记综合状态：

颜色规则（融合态度🔴🟡⚪ + 掌握度L0-L5）：
├── 🔴必须拿满 + L4/L5 → 深绿色 ✅ "稳了"
├── 🔴必须拿满 + L1-L3 → 红色 🔴 "你最该练这个"
├── 🔴必须拿满 + L0 → 灰红色 ⚠️ "还没测过但很重要"
├── 🟡争取 + L4/L5 → 浅绿色 "不错，继续保持"
├── 🟡争取 + L1-L3 → 橙色 "有机会提升"
├── 🟡争取 + L0 → 灰橙色 "有空测一下"
├── ⚪可放弃 + 任意Level → 灰色 "不需要在这花时间"
└── 有待诊断错题的题号 → 闪烁标记

点击任意题号 → 展开该题关联的模型列表 + 每个模型的Level

数据来源：
├── 卷面结构 → Section四十六 地区模板（教研预设）
├── 题号态度 → Section十四 卷面策略表（纯规则生成）
├── 掌握度 → Section二十九 后端标签（学习行为积累）
├── 题号→模型映射 → 教研预设（question_map）
└── 成本：0（纯前端渲染，规则层计算）
```

### 第二层：模型漏斗图（详情层 → 支撑卖点C）
```
展示位置：模型详情页P8 + 点击热力图题号后的展开区

展示内容：
每个模型一个4层漏斗，从上到下：
┌────────────────────┐
│     建模层(L1)      │  ← ✅通过 / ❌卡住 / ⬜未到达
├────────────────────┤
│     列式层(L2)      │
├────────────────────┤
│     执行层(L3)      │
├────────────────────┤
│    稳定层(L4-L5)    │  ← L4=做对过(1次) / L5=稳定(延时通过)
└────────────────────┘

漏斗右侧显示：
├── 当前Level + 对应的瓶颈描述
├── "解决后预计+X分"（关联目标分数）
└── [开始训练] 按钮

家长看得懂的话术示例：
├── L1: "孩子看到这类题，还不确定该用什么方法"
├── L2: "知道方法了，但选公式这步还不够熟练"
├── L3: "公式选对了，代入数字和计算这步还需要练"
├── L4: "做对过一次了，需要隔段时间再测验确认"
└── L5: "可靠掌握，放心 ✅"

数据来源：
├── current_level → Section二十九 后端标签
├── 四层诊断结果 → Section二 AI诊断输出
├── "+X分"预测 → Section二十七 预测算法
└── 成本：0（纯前端渲染）
```

### 家长看到的（不做家长端，通过学生截图/分享页）
- 学生截图卷面热力图 → 家长一看就知道"哪些题稳了、哪些题还不行"
- 每个模型的漏斗图 + 家长话术 → "孩子卡在公式选择，不是不努力"
- 周复盘页截图 → 本周进步了哪些、下周重点是什么

---

## 四十九、上传错题未诊断超时处理（已确认Q69B）

```
学生上传标错后，如果3天内未进入AI诊断：

0-3天：
├── 每次打开App → 推荐列表顶部显示"你有X道待诊断错题"
├── 点击推荐卡片 → 直接进入P14 AI诊断
├── current_level暂不降级

3天后仍未诊断：
├── 自动保守降级到L3（执行卡住）
│   理由：统计上执行层错误（代入错/计算错）是最常见的出错层，
│         用L3作为默认值比盲降L1更合理
├── 推荐列表标签变为"⚠️ 超过3天未诊断"
├── 如果学生之后补做诊断 → AI定位到真实层次 → Level修正到正确的值
└── 如果始终不诊断 → 保持L3，直到下一次该模型相关的学习行为更新

特殊情况：
├── 如果model之前就是L1/L2 → 不降级（已经比L3低了）
├── 如果model是L0 → 设为L3（第一次接触就标错，给个默认值）
└── 如果model是L5 → 降到L4（保守，不直接降到L3）

数据来源：
├── diagnosis_status字段 = pending + 创建时间 → 计算是否超过3天
├── 定时任务：每天凌晨扫描所有pending且>3天的记录 → 执行默认降级
└── 成本：0（纯规则，定时任务）
```

---

## 五十、延时复测等待期利用策略（已确认Q70C）

```
当模型处于L4（做对过）且等待延时复测（next_retest_date未到）时：

推荐策略（按优先级）：
1. 推其他薄弱模型（L1-L3的🔴必须拿满模型优先）
2. 穿插同族模型巩固：
   └── 根据"模型关联图"（教研预设），推荐同族但不同的模型
   └── 例：L4了"匀变速直线运动" → 推"自由落体"（同族的具体场景）
   └── 目的：通过相关场景间接巩固，不是直接复测
3. 常规推荐（待诊断错题、不稳定模型等）

模型关联图：
├── 教研团队预设，每个模型标注"关联模型"列表
├── 例：{
│     "匀变速直线运动": ["自由落体", "竖直上抛"],
│     "牛顿第二定律-斜面": ["板块运动", "传送带"],
│     "动能定理": ["机械能守恒", "功能关系"]
│   }
├── 存储在question_map数据库中
└── 成本：教研一次性预设，运行时0成本

等待期不推该模型本身的训练/测试。等到next_retest_date到了 → 自动出现在推荐列表中。

数据来源：
├── next_retest_date → Section八 延时复测机制写入
├── 模型关联图 → model_relations表（教研预设）
├── 其他薄弱模型 → current_level + exam_strategy中的🔴模型
└── 成本：0（纯规则排序）
```

---

## 五十一、跨模型依赖处理（已确认Q71C：自适应检测）

```
设计原则：
不阻拦学生进入任何模型的训练（避免挫败感），
但在训练过程中如果发现前置模型/知识点缺口，自动跳转处理。

实现方式：
1. 教研预设"模型前置依赖表"：
   model_prerequisites = {
     "板块运动": ["牛顿第二定律", "摩擦力分析"],
     "碰撞": ["动量定理", "动量守恒"],
     "电磁感应-单棒切割": ["安培力", "法拉第电磁感应定律"],
     ...
   }

2. 训练流程中的检测时机：
   Step 1（过程拆分+识别）时：
   ├── 如果学生连识别都做不到 → 检查前置依赖
   │   ├── 前置模型Level < L4 → 弹出提示：
   │   │   "这个模型用到了XX（你还在L2-列式卡住），建议先搞定XX再回来"
   │   │   ├── [先学XX] → 跳转到前置模型训练 → 完成后自动返回
   │   │   └── [继续当前] → 不阻拦，继续训练
   │   └── 前置模型Level >= L4 → 不是前置问题，继续正常训练
   └── 如果识别成功 → 正常进行，不检查前置

3. 和知识点缺口检测的统一：
   - 训练中发现知识点不会 → 插入知识点学习（已有逻辑）
   - 训练中发现前置模型不会 → 跳转前置模型训练（新增）
   - 两者用同一个机制：在Step 1中检测，发现问题就跳转

4. 跳转记录：
   ├── 系统记录"从A跳转到B" → B完成后弹出"你之前在练A，回去继续？"
   ├── 最多嵌套1层（A→B，但B中不再跳C，避免无限嵌套）
   └── 如果B的前置也不行 → 只提示"建议先学CC"，不自动跳转

数据来源：
├── model_prerequisites → 教研预设表（一次性制作）
├── 前置模型Level → Section二十九后端标签
├── 检测时机 → Step 1中规则判断
└── 成本：0（纯规则判断）
```

---

## 五十二、预测分数算法（Q72重写：完整数据来源追溯）

### 算法目标
给学生一个"如果现在考高考，你大概能得多少分"的预测值。

### 输入数据（每一项标注来源）
```
1. question_map: {题号 → [所需模型列表, 所需知识点列表, 该题满分]}
   来源：教研团队预设（per region）
   更新频率：每年高考后根据最新试卷结构更新
   存储：数据库表 question_map

2. student_model_mastery: {model_id → current_level, is_unstable, last_error_subtype}
   来源：Section二十九后端标签，由以下行为更新：
   ├── 训练做对/做错 → 精确升降级
   ├── 上传标错 → 诊断后精确降级 / 超时默认降到L3
   ├── 快检结果 → 通过不变 / 失败降L1
   ├── 延时复测 → 通过维持/升级 / 失败降到出错层
   └── AI诊断完成 → 按四层定位更新

3. student_kp_mastery: {kp_id → current_level}
   来源：同上，知识点相关活动更新

4. exam_strategy: {题号 → attitude(🔴🟡⚪)}
   来源：Section十四卷面策略（纯规则，target_score + regional_template生成）

5. pending_diagnosis_count: int
   来源：diagnosis_status == pending的错题数量
```

### 预测公式（V1）
```
对于每个题号 q:
  1. 查 question_map[q] → required_models[], required_kps[], max_score
  
  2. 对每个 required_model m:
     base_prob = level_to_prob[m.current_level]  // 基础概率
     
     // 不稳定折扣
     if m.is_unstable:
       base_prob *= 0.7
     
     // error_subtype微调（Q72C：±5%修正）
     if m.current_level == 3:  // 执行卡住时，细分错误影响不同
       if m.last_error_subtype == "calc_error":
         base_prob += 0.05  // 纯计算错相对容易改善
       elif m.last_error_subtype == "subject_wrong":
         base_prob -= 0.05  // 主语错比较根本
     
     model_prob[m] = base_prob
  
  3. 对每个 required_kp k:
     kp_prob = level_to_prob[k.current_level]  // 知识点不设is_unstable
  
  4. question_prob = min(所有model_prob[], 所有kp_prob[])
     // 最弱环节决定得分（木桶原则）
  
  5. predicted_score[q] = question_prob × max_score

level_to_prob（V1初始值，基于新Level含义）：
  模型：L0=0.05, L1=0.10, L2=0.25, L3=0.50, L4=0.80, L5=0.92
  知识点：L0=0.05, L1=0.10, L2=0.30, L3=0.55, L4=0.85, L5=0.93
  
  为什么模型和知识点概率不同：
  - 模型L2(列式卡住)=0.25：知道方法但选错公式，选择题有蒙对可能
  - 知识点L2(理解不深)=0.30：记住了但不深理解，简单题能答对
  - L3差异原因同理：执行层错误有部分得分可能

总预测分 = sum(predicted_score[q] for all q)

// 未诊断错题折扣
if pending_diagnosis_count > 0:
  总预测分 *= max(0.90, 1 - pending_diagnosis_count * 0.02)
  // 每道未诊断错题扣2%，最多扣10%
  // 展示："预测65-70分（有3道未诊断错题可能影响预测准确度）"
```

### level_to_prob校准方法
```
V1：使用上述初始值（教师经验判断）

校准时机：
├── 学生上传考试卷子（有真实分数时）
├── 用真实得分 vs 预测得分计算偏差
├── 每积累10份真实考试数据后，调整level_to_prob参数
└── 方法：简单线性回归 predicted_score ≈ a × actual_score + b

数据来源：
├── 真实得分 → Section四十七考试卷子上传（学生输入总分）
├── 预测得分 → 上传时点的预测快照
└── 成本：0（纯数值计算）
```

---

## 五十三、定价模型（已确认Q74C+用户定价策略）

### 定价结构
```
产品A：首次诊断（独立付费产品）
├── 价格：500元
├── 包含：注册 → 卷面策略 → 自适应AI诊断（15-30分钟）→ 诊断报告
├── 产出物：
│   ├── 卷面策略表（"你想考70分，这是你的高考地图"）
│   ├── 四层诊断结果（每个测过的模型：建模✅/❌ → 列式✅/❌ → 执行✅/❌）
│   ├── 三维初始画像（公式记忆/模型识别/计算准确度）
│   └── 预测当前分数 + 提分路径摘要
├── 设计目标：这份报告本身就是营销材料——学生/家长看完就想升级
└── 成本：~1.5元AI调用

产品B：升级到高考前（一次付清）
├── 价格：3000元（覆盖到2026年高考前的全部功能）
├── 包含：产品A的全部 + 所有训练/推荐/复盘/上传功能
├── 不做月付：高三下学期只剩~3个月，月付磨蹭时间
└── 换算：~1000元/月，在目标价值区间内

开发策略（已确认Q82）：产品A和B一起开发。
├── 不分阶段做：500诊断和3000完整版同步开发
├── 砍掉的：社区Tab（不影响核心价值，后续再说）
├── 核心功能全做：注册→诊断→报告→训练→上传→推荐→复盘→预测→分享页
└── 社区/小队/投票等运营功能 = V2

为什么诊断单独卖：
1. 不愿为诊断付费的用户，后续也不会付费（筛选意愿）
2. 诊断报告是"试用"——但有完整价值（不是阉割版）
3. 高三只剩3个月，没有时间"免费试用再决定"
4. 诊断报告可截图分享 → 自然传播 → 获客
```

### 诊断报告设计要求（因为它是独立产品）
```
诊断报告必须做到：
1. 一张截图就能看懂（家长转发用）
2. 明确指出"你的问题是什么"（痛点）
3. 明确说"这不难解决"（希望）
4. 明确关联分数"解决后预计+X分"（价值量化）
5. 视觉效果"像看电影一样"（体验感）

报告页面结构（P_report，新增）：
├── 顶部大字：预测当前分 XX / 目标分 YY
├── 卷面热力图（概览：哪些题稳了、哪些题还差）
├── 核心发现区（2-3条最关键的四层诊断结论）
│   示例："你的板块运动卡在第2步（公式选择），解决后选择题第5题能稳拿3分"
├── 提分路径（"攻克这3个模型，预计+12分"）
└── 底部CTA："升级到完整版，三个月搞定这些"

### 诊断报告体验设计（已确认Q79C：动态揭晓+静态报告）
```
诊断完成后的体验流程（两阶段）：

阶段1：动态揭晓（创造"Aha Moment"，约60秒）
├── Step 1（5s）：全屏大字"你的物理诊断报告"+ 加载动画
├── Step 2（10s）：目标分弹出 → "你想考70分"
│   → 卷面全景图渐显，题号一个个亮起颜色
│   → 🔴必须拿满的题号强调闪烁
├── Step 3（15s）：核心发现逐条浮入
│   → "发现1：板块运动 - 卡在公式选择（第2步）"
│   → "发现2：圆周运动 - 卡在代入计算（第3步）"
│   → 每条旁边标注"+X分"
├── Step 4（10s）：预测当前分数 → 大数字动画跳出
│   → "当前预测：58分 → 目标：70分 → 差距：12分"
├── Step 5（10s）：提分路径
│   → "攻克这3个模型 → 预计+12分 → 达到目标"
│   → 三个模型名称 + 预计时间
├── Step 6（10s）：结尾
│   → "这些问题不难，你三个月能搞定"
│   → CTA按钮："查看完整报告" / "立即开始训练"

阶段2：静态报告页（方便截图分享）
├── 和动态揭晓相同的内容，但以静态页面形式排版
├── 专为截图设计：关键信息在一屏内
├── 分享按钮 → 生成H5链接（家长/老师点开就能看）
├── 底部CTA："升级到完整版（¥3000到高考前）"

技术实现：
├── 动态揭晓 = 前端CSS动画 + 预计算的数据
├── 不需要AI实时生成（数据在诊断完成时已全部计算好）
├── 成本：0（纯前端渲染）
```
```

---

## 五十四、周复盘详细内容（已确认Q75C：叙事+数据）

### 复盘页内容结构
```
1. AI叙事总结（给家长截图用，~100字）
   示例："本周你在板块运动和动能定理上有突破——从'公式选不对'提升到'做对过'。
   预测分从62分提升到65分。下周重点是把圆周运动的代入问题解决，预计还能+3分。"
   
   数据来源：
   ├── Level变化 → 本周末Level vs 上周末Level（from后端标签历史快照）
   ├── 预测分变化 → 本周末预测 vs 上周末预测（from预测历史）
   ├── 下周重点 → 推荐算法Top 1模型的四层诊断结论
   └── 成本：~0.05元/次（短prompt生成总结文本）

2. Level变化表（学生细看用）
   | 模型/知识点 | 上周Level | 本周Level | 变化 |
   |-----------|----------|----------|------|
   | 板块运动 | L2(列式卡住) | L4(做对过) | ↑↑ |
   | 动能定理 | L1(建模卡住) | L2(列式卡住) | ↑ |
   | 圆周运动 | L3(执行卡住) | L3(执行卡住) | → |
   
   只显示有变化的 + 🔴必须拿满的模型，不展示全部
   
   数据来源：
   ├── 每周日凌晨快照所有模型/知识点的current_level
   ├── 与上周快照对比
   └── 成本：0（纯规则）

3. 预测分变化（大数字+趋势）
   ├── 本周预测分（大字）
   ├── vs上周（+X分 / -X分 / 持平）
   ├── 近4周趋势小折线图
   └── 数据来源：每周预测快照

4. 本周数据卡片
   ├── 完成闭环数
   ├── 诊断错题数
   ├── 上传题目数
   ├── 闪卡复习数
   └── 延时复测通过/失败数

5. 下周Top 3推荐（可点击）
   ├── 推荐算法输出
   ├── 每条显示理由标签
   └── 点击直接进入训练

6. 粗心消杀入口（如果本周有粗心记录）
```

---

## 五十五、分销策略与渠道设计（已确认Q77方向）

### 核心假设
> 这个产品应该像"商品"一样好卖——别人帮你卖比你自己卖快10倍。
> 关键：让渠道觉得"推荐这个产品 = 对学生/家长好 + 自己有收益"。

### 目标渠道（按优先级）
```
1. 机构小老师（最快）
   ├── 特点：有现成的学生，和家长有信任关系
   ├── 动机：推荐好工具 → 学生成绩提高 → 自己口碑好 + 佣金
   ├── 推荐方式：课后跟家长说"这个诊断工具我觉得你孩子可以试试"
   ├── 佣金：诊断500×30%=150元/人，升级3000×20%=600元/人
   └── 需要给他们：一张诊断报告截图（示例）+ 一句话话术

2. 家长口碑传播（最可信）
   ├── 特点：家长群里家长推荐 → 其他家长信任度极高
   ├── 动机：我孩子用了觉得好 → 分享 + 老带新奖励
   ├── 传播物：诊断报告截图（自带传播性）
   └── 老带新：推荐一个新用户完成诊断 → 奖励100元现金/抵扣

3. 教育组织/社群（扶鹰、鼎校、鼎伴学等）（最大规模）
   ├── 特点：有现成的家长网络和社群运营能力
   ├── 合作方式：组织内核心人员作为"推荐官"
   ├── 佣金：更高比例或团购价
   └── 需要给他们：品牌素材包 + 诊断demo + 渠道专属链接/码
```

### 让渠道好卖的关键设计
```
1. 诊断报告 = 最好的营销材料
   ├── 报告设计必须"一张截图说明一切"
   ├── 家长看完就知道值不值
   └── 分享报告 → 自然获客（不需要渠道"推销"）

2. 品牌概念（10秒内能说清楚）
   需要设计3个核心品牌概念，让任何人10秒内能给别人解释清楚产品是什么。
   （待具体讨论确定——见Q78）

3. 老师/家长视角 = 学生数据展示
   ├── 不做独立的"家长端"或"老师端"App
   ├── 方案：学生账号生成"分享页"链接（只读）
   │   ├── 家长打开链接 = 看到孩子的卷面热力图 + Level变化 + 预测分
   │   ├── 老师打开链接 = 看到学生的状态（和学生看到的一模一样）
   │   └── 不需要注册、不需要下载
   ├── 实现：一个只读的H5页面，学生点"分享给家长"→生成带token的链接
   └── 开发成本：极低（就是学生页面的只读版）
```

### V1上线范围（已确认Q73C：双城集）
```
首批城市：天津 + 另一个城市（验证多城架构通用性）
首批科目：物理
教研内容：全部模型+知识点预设 + 模型关联图 + 前置依赖表
预估教研工时：5-6周
```

---

## 五十六、算法清晰度原则（Q76B）

### 通用要求
> 所有涉及判断/计算的算法，必须写清楚：
> 1. **输入数据**：每个变量从哪来、什么格式
> 2. **判断标准**：阈值/规则从哪来（教研预设 / 统计 / 经验值）
> 3. **输出结果**：产出什么、写到哪个字段
> 4. **触发时机**：什么事件触发这个算法
> 5. **成本**：AI调用次数和预估费用

### 已达标的算法
- ✅ 预测分数算法（Section 五十二，Q72重写版）
- ✅ 标签更新算法（Section 二十九，Q63重构版）
- ✅ 延时复测机制（Section 八）
- ✅ 超时降级规则（Section 四十九）

### 待补充数据来源的算法（需要通过提问获得信息）
- ⬜ 推荐排序算法（Section 十）→ 需补充排序权重的具体数值
- ⬜ 考试卷子上传处理（Section 四十七）→ 涉及外部流程，需提问确认
- ⬜ 闪卡SM-2参数（Section 十五）→ 标准算法但需确认定制参数
- ⬜ 卷面策略生成规则（Section 十四）→ 需补充"允许扣分"的分配逻辑

### 数据字典（独立文档）
> 计划创建独立数据字典文档，包含：每个字段的定义、数据类型、来源、更新时机、默认值。
> 通过逐步提问用户完善。

---

## 待讨论事项

- 四大研究方向：
  1. 状态可视化 → Q68C双层展示已确认
  2. 我们的题测试 → 待深化
  3. 学生的题更新 → 待深化（Q76要求提问获取算法信息）
  4. 状态驱动推荐 → Q70C/Q71C已确认
- 商业策略：Q74定价/Q77分销已确认方向，品牌概念待设计
